<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ONE21 — Command Console</title>
<link rel="stylesheet" href="/css/design-system.css">
<link rel="stylesheet" href="/api/theme/active.css">
<link rel="stylesheet" href="/css/layers/pages/admin.css">
</head>
<body>

<div class="admin-layout">

  <!-- ══════════════════════════════════════
       SIDEBAR
       ══════════════════════════════════════ -->
  <nav class="admin-nav">

    <div class="admin-nav__brand">
      <div class="brand-logo">
        <span class="brand-logo__box">ONE</span>
        <span class="brand-logo__suffix">_21</span>
      </div>
      <span class="admin-nav__console-label">CONSOLE</span>
    </div>

    <div class="admin-nav__section">Command_Modules</div>

    <button class="admin-nav__item active" data-page="overview">
      <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Overview
    </button>
    <button class="admin-nav__item" data-page="users">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Node_Registry
    </button>
    <button class="admin-nav__item" data-page="invites">
      <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      Access_Codes
    </button>
    <button class="admin-nav__item" data-page="rooms">
      <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Node_Map
    </button>

    <button class="admin-nav__item" data-page="search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Neural_Search
    </button>
    <button class="admin-nav__item" data-page="export">
      <svg viewBox="0 0 24 24"><polyline points="8 17 12 21 16 17"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"/></svg>
      Data_Export
    </button>
    <button class="admin-nav__item" data-page="settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
      Settings
    </button>

    <div class="admin-nav__footer">
      <button class="admin-nav__footer-btn" onclick="goToChat()">
        <svg viewBox="0 0 24 24"><polyline points="9 10 4 15 9 20"/><path d="M20 4v7a4 4 0 0 1-4 4H4"/></svg>
        Return_To_Chat
      </button>
      <button class="admin-nav__footer-btn admin-nav__footer-btn--danger" onclick="Auth.logout()">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Terminate_Session
      </button>
    </div>

  </nav>


  <!-- ══════════════════════════════════════
       MAIN CONTENT
       ══════════════════════════════════════ -->
  <main class="admin-main">

    <!-- ── OVERVIEW ── -->
    <div class="admin-page active" id="page-overview">

      <div class="admin-page-header">
        <div class="admin-page-label">System_Status</div>
        <div class="admin-page-title">Overview</div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-card__label">Loading...</div>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-section__header">
          <span class="admin-section__title">Recent_Activity</span>
          <button class="t-btn t-btn--accent" onclick="loadOverview()">
            <svg class="icon-svg icon-svg--xs" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Refresh
          </button>
        </div>
        <table id="recentTable">
          <thead>
            <tr>
              <th>Node_ID</th>
              <th>Access_Level</th>
              <th>Last_Transmission</th>
              <th>Msg_Count</th>
            </tr>
          </thead>
          <tbody id="recentBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── USERS ── -->
    <div class="admin-page" id="page-users">

      <div class="admin-page-header">
        <div class="admin-page-label">Access_Control</div>
        <div class="admin-page-title">Node_Registry</div>
      </div>

      <div class="admin-toolbar">
        <input class="admin-toolbar__input" type="text" id="userSearch" placeholder="QUERY_NODE..." oninput="filterUsers()">
        <span class="admin-toolbar__count" id="userCount"></span>
      </div>

      <div class="admin-section">
        <table id="usersTable">
          <thead>
            <tr>
              <th>Node_ID</th>
              <th>Access_Level</th>
              <th>Status</th>
              <th>Msg_Count</th>
              <th>Registered</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── INVITES ── -->
    <div class="admin-page" id="page-invites">

      <div class="admin-page-header">
        <div class="admin-page-label">Access_Management</div>
        <div class="admin-page-title">Access_Codes</div>
      </div>

      <div class="admin-toolbar">
        <button class="t-btn t-btn--accent t-btn--lg" onclick="openInviteModal()">
          <svg class="icon-svg icon-svg--xs" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Generate_New_Code
        </button>
      </div>

      <div class="admin-section">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Issued_By</th>
              <th>Created</th>
              <th>Claimed_By</th>
              <th>Expires</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="invitesBody"></tbody>
        </table>
      </div>

    </div>



    <!-- ── NEURAL SEARCH ── -->
    <div class="admin-page" id="page-search">
      <div class="admin-page-header">
        <div class="admin-page-label">Semantic_Query</div>
        <div class="admin-page-title">Neural_Search</div>
      </div>
      <div class="admin-toolbar">
        <input class="admin-toolbar__input admin-toolbar__input--grow" type="text" id="searchQuery"
          placeholder="QUERY_NEURAL_NETWORK..." onkeydown="if(event.key==='Enter') runSearch()">
        <select id="searchCollection" class="inline-select">
          <option value="all">All</option>
          <option value="messages">Messages</option>
          <option value="admin_events">Admin Events</option>
        </select>
        <button class="t-btn t-btn--accent" onclick="runSearch()">Search</button>
      </div>
      <div class="admin-section" id="searchResultsContainer">
        <div class="u-dim">Enter a query to search semantically across all interactions.</div>
      </div>
    </div>

    <!-- ── ROOMS ── -->
    <div class="admin-page" id="page-rooms">

      <div class="admin-page-header">
        <div class="admin-page-label">Topology</div>
        <div class="admin-page-title">Node_Map</div>
      </div>

      <div class="admin-toolbar">
        <input class="admin-toolbar__input" type="text" id="roomSearch" placeholder="QUERY_NODE..." oninput="filterRooms()">
        <button class="t-btn t-btn--accent" onclick="openCreateRoom()">+ New_Node</button>
        <input class="admin-toolbar__input admin-toolbar__input--node-id" type="text" id="deleteByNodeIdInput" placeholder="Node_ID to delete">
        <button class="t-btn t-btn--reject" onclick="deleteRoomByNodeId()">Delete by Node_ID</button>
      </div>

      <div class="admin-section">
        <table id="roomsTable">
          <thead>
            <tr>
              <th>Node_Name</th>
              <th>Type</th>
              <th>Listeners</th>
              <th>Msg_Count</th>
              <th>Last_Transmission</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="roomsBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── EXPORT ── -->
    <div class="admin-page" id="page-export">

      <div class="admin-page-header">
        <div class="admin-page-label">Data_Operations</div>
        <div class="admin-page-title">Data_Export</div>
      </div>

      <div class="admin-section">
        <div class="admin-section__header">
          <span class="admin-section__title">Select_Node_For_Export</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Node_Name</th>
              <th>Type</th>
              <th>Msg_Count</th>
              <th>Listeners</th>
              <th>Export</th>
            </tr>
          </thead>
          <tbody id="exportBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── SETTINGS ── -->
    <div class="admin-page" id="page-settings">

      <div class="admin-page-header">
        <div class="admin-page-label">System_Config</div>
        <div class="admin-page-title">Settings</div>
      </div>

      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="api-keys">API_Keys</button>
        <button class="settings-tab" data-tab="themes">UI_Themes</button>
      </div>

      <div class="settings-panel active" id="settings-tab-api-keys">
        <div class="admin-section">
          <div class="admin-section__header">
            <span class="admin-section__title">Claude_API_Key</span>
          </div>
          <div class="settings-field">
            <label class="settings-field__label">CLAUDE_API_KEY</label>
            <div class="settings-field__row">
              <input type="password" id="claudeApiKeyInput" class="input" placeholder="sk-ant-••••••••••••••••">
              <button class="btn btn--primary btn--sm" onclick="saveApiKey()">Save</button>
            </div>
            <p class="settings-field__hint" id="apiKeyStatus">—</p>
          </div>
        </div>
      </div>

      <div class="settings-panel" id="settings-tab-themes">
        <div class="admin-section">
          <div class="admin-section__header">
            <span class="admin-section__title">Themes</span>
            <button class="btn btn--primary btn--sm" onclick="openThemeEditor(null)">+ New Theme</button>
          </div>
          <div id="themesList" class="themes-list">
            <div class="themes-list__loading">Loading...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- ── THEME EDITOR MODAL ── -->
    <div class="theme-editor-overlay u-hidden" id="themeEditorOverlay">
      <div class="theme-editor">

        <div class="theme-editor__header">
          <input type="text" class="theme-editor__name" id="themeEditorName" placeholder="Theme name...">
          <div class="theme-editor__actions">
            <button class="btn btn--ghost btn--sm" onclick="closeThemeEditor()">Cancel</button>
            <button class="btn btn--ghost btn--sm" onclick="themeEditorUndo()" id="btnThemeUndo" title="Undo last change">Undo</button>
            <button class="btn btn--ghost btn--sm" onclick="themeEditorExport()" title="Download theme JSON">Export</button>
            <button class="btn btn--secondary btn--sm" onclick="showSaveAsNew()" id="btnSaveAsNew">Save as New Theme</button>
            <button class="btn btn--primary btn--sm" onclick="saveTheme()">Save Theme</button>
          </div>
        </div>

        <div class="theme-editor__body">
          <div class="theme-editor__chat">
            <div class="theme-editor__apply-bar u-hidden" id="themeApplyBar">
              <span class="theme-editor__apply-bar-text">You have a text suggestion.</span>
              <button type="button" class="btn btn--primary btn--sm" id="themeApplyBarBtn" onclick="applyLastSuggestion()">Apply suggestion → Preview & tokens</button>
            </div>
            <div class="theme-editor__chat-messages" id="themeChat"></div>
            <div class="theme-editor__chat-input">
              <input type="text" id="themeChatInput" placeholder="Describe what you want (e.g. red accent, light theme, cyberpunk, gradients)..." onkeydown="if(event.key==='Enter')sendThemeChat()">
              <button class="btn btn--primary btn--sm" onclick="sendThemeChat()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              </button>
            </div>
          </div>
          <div class="theme-editor__preview">
            <div class="theme-editor__preview-header">
              <span class="theme-editor__preview-label">PREVIEW</span>
              <button type="button" class="btn btn--ghost btn--sm theme-editor__preview-fullscreen" onclick="themeEditorFullscreenPreview()" title="Open preview in new window">Fullscreen</button>
            </div>
            <iframe class="theme-editor__iframe" id="themePreviewFrame" src="/login.html" sandbox="allow-same-origin allow-scripts" tabindex="-1"></iframe>
            <div class="theme-editor__tokens-label">TOKENS</div>
            <div class="theme-editor__tokens-block" id="themeTokensBlock">
              <div class="theme-editor__tokens-resize" id="themeTokensResize" title="Drag to resize" aria-label="Resize tokens panel"></div>
              <div class="theme-editor__tokens" id="themeTokensList"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

  <!-- ── SAVE AS NEW THEME MODAL ── -->
  <div class="modal-overlay" id="saveAsNewOverlay" onclick="if(event.target===this)hideSaveAsNew()">
    <div class="modal">
      <div class="modal__header">
        <span class="modal__title">Save as New Theme</span>
      </div>
      <div class="modal__body">
        <div class="modal__field">
          <label>Theme Name</label>
          <input type="text" class="input" id="newThemeNameInput" placeholder="Ex: Neural Blue, Amber Dark..."
            onkeydown="if(event.key==='Enter')confirmSaveAsNew(); if(event.key==='Escape')hideSaveAsNew()">
        </div>
      </div>
      <div class="modal__footer">
        <button class="btn btn--ghost btn--sm" onclick="hideSaveAsNew()">Cancel</button>
        <button class="btn btn--primary btn--sm" onclick="confirmSaveAsNew()">Save</button>
      </div>
    </div>
  </div>

  </main>

  <!-- ── USER PERMISSIONS PANEL ── -->
  <div class="perms-panel" id="permsPanel">
    <div class="perms-panel__header">
      <span class="perms-panel__title" id="permsPanelTitle">Node_Permissions</span>
      <button class="perms-panel__close" onclick="closePermsPanel()">✕</button>
    </div>
    <div class="perms-panel__body" id="permsPanelBody">
      <div class="u-dim">Select a node to view permissions.</div>
    </div>
    <div class="perms-panel__footer">
      <button class="t-btn t-btn--accent" onclick="savePermissions()">Save_Permissions</button>
      <button class="t-btn" onclick="closePermsPanel()">Cancel</button>
    </div>
  </div>
  <div class="perms-overlay" id="permsOverlay" onclick="closePermsPanel()"></div>

  <!-- ── INVITE WIZARD MODAL ── -->
  <div class="modal-overlay" id="inviteModal">
    <div class="modal">
      <div class="modal__header">
        <span class="modal__title">Generate_Access_Code</span>
        <button class="modal__close" onclick="closeInviteModal()">✕</button>
      </div>
      <div class="modal__body">
        <div class="perm-row">
          <span class="perm-row__label">Preset</span>
          <select id="invitePreset" onchange="applyInvitePreset(this.value)" class="inline-select">
            <option value="guest">Guest (no files, no AI)</option>
            <option value="standard" selected>Standard</option>
            <option value="ai">AI User (all agents)</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div id="inviteCustomPerms" class="invite-custom-perms">
          <div class="perm-row">
            <span class="perm-row__label">can_send_files</span>
            <input type="checkbox" class="perm-toggle" id="inv_files" checked>
          </div>
          <div id="inv_agents_section"></div>
        </div>
        <div class="invite-note-block">
          <div class="perm-row__label invite-note-label">Note (optional)</div>
          <input type="text" id="inviteNote" placeholder="e.g. For marketing team" class="admin-toolbar__input invite-note-input">
        </div>
      </div>
      <div class="modal__footer">
        <button class="t-btn t-btn--accent" onclick="generateInviteWithPerms()">Generate_Code</button>
        <button class="t-btn" onclick="closeInviteModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ── CREATE / EDIT CHANNEL MODAL ── -->
  <div class="modal-overlay" id="roomModal">
    <div class="modal">
      <div class="modal__header">
        <span class="modal__title" id="roomModalTitle">New_Channel</span>
        <button class="modal__close" onclick="closeRoomModal()">✕</button>
      </div>
      <div class="modal__body">
        <div class="modal__field" id="roomModalTypeWrap">
          <label class="modal__label">Type</label>
          <select class="inline-select" id="roomModalType">
            <option value="channel">Channel</option>
            <option value="group">Group</option>
          </select>
        </div>
        <div class="modal__field">
          <label class="modal__label">Name</label>
          <input class="input" type="text" id="roomModalName" placeholder="node-name" maxlength="80">
        </div>
        <div class="modal__field">
          <label class="modal__label">Description</label>
          <input class="input" type="text" id="roomModalDesc" placeholder="Optional description" maxlength="200">
        </div>
        <div class="modal__field room-modal-archived-wrap" id="roomModalArchivedWrap">
          <label class="modal__label room-modal-archived-label">
            <input type="checkbox" id="roomModalArchived" class="perm-toggle">
            <span>Archived</span>
          </label>
        </div>
        <div class="modal__field">
          <label class="modal__label">Members</label>
          <input class="input" type="text" id="roomModalMemberSearch" placeholder="Search users..." oninput="filterRoomModalUsers()">
          <div id="roomModalUserList" style="margin-top:var(--sp-2);max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:var(--sp-1);"></div>
        </div>
        <div id="roomModalError" class="u-error" style="display:none;"></div>
      </div>
      <div class="modal__footer">
        <button class="t-btn t-btn--accent" onclick="saveRoom()">Save_Node</button>
        <button class="t-btn" onclick="closeRoomModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ── MEMBERS PANEL ── -->
  <div class="perms-panel" id="membersPanel">
    <div class="perms-panel__header">
      <span class="perms-panel__title" id="membersPanelTitle">Members</span>
      <button class="perms-panel__close" onclick="closeMembersPanel()">✕</button>
    </div>
    <div class="perms-panel__body" id="membersPanelBody">
      <div class="u-dim">Select a channel to view members.</div>
    </div>
    <div class="perms-panel__footer">
      <div style="display:flex;gap:var(--sp-2);width:100%;">
        <input class="input" type="text" id="addMemberSearch" placeholder="Add member..." oninput="filterAddMemberList()" style="flex:1;">
        <div id="addMemberDropdown" style="display:none;position:absolute;bottom:calc(var(--sp-12) + var(--sp-4));left:var(--sp-4);right:var(--sp-4);background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:4px;max-height:150px;overflow-y:auto;z-index:var(--z-dropdown);"></div>
      </div>
    </div>
  </div>
  <div class="perms-overlay" id="membersOverlay" onclick="closeMembersPanel()"></div>

</div>


<script src="/socket.io/socket.io.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/system-dialogs.js"></script>
<script>
// ── Auth guard ──────────────────────────────────
if (!Auth.requireAuth()) {
  const u = Auth.getUser();
  if (u && u.role !== 'admin') {
    showAlert('Acces restricționat — doar administratori.').then(function () { window.location.href = '/chat.html'; });
  }
}

// ── Presence (keep admin online while on this page) ──
(function () {
  const token = Auth.getToken();
  if (token) {
    const socket = io({ auth: { token } });
    socket.on('connect_error', () => {});
  }
})();

let allUsers = [];
let allRooms = [];

// ── Navigation ────────────────────────────────────
document.querySelectorAll('.admin-nav__item[data-page]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.admin-nav__item').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`page-${btn.dataset.page}`).classList.add('active');

    const loaders = { overview: loadOverview, users: loadUsers, invites: loadInvites, rooms: loadRooms, export: loadExport, 'search': () => {}, settings: () => { loadSettings(); loadThemes(); } };
    loaders[btn.dataset.page] && loaders[btn.dataset.page]();
  });
});

function goToChat() { window.location.href = '/chat.html'; }

// ── Toast ─────────────────────────────────────────
function toast(msg, duration = 2500) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), duration);
}

// ── Helpers ───────────────────────────────────────
function formatDate(iso) {
  if (!iso) return '—';
  const d = new Date(iso.includes('T') ? iso : iso.replace(' ', 'T') + 'Z');
  return d.toLocaleDateString('ro-RO', { day: '2-digit', month: 'short', year: 'numeric' });
}
function formatTime(iso) {
  if (!iso) return '—';
  const d = new Date(iso.includes('T') ? iso : iso.replace(' ', 'T') + 'Z');
  return d.toLocaleString('ro-RO', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
}

// ── Overview ──────────────────────────────────────
async function loadOverview() {
  const [statsData, usersData] = await Promise.all([
    Auth.api('/api/admin/stats'),
    Auth.api('/api/admin/users'),
  ]);
  if (!statsData || !usersData) return;

  const s = statsData.stats;
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card stat-card--accent">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
      <div class="stat-card__value">${s.users}</div>
      <div class="stat-card__label">Active_Nodes</div>
      <div class="stat-card__sub">${s.online_now} online now</div>
    </div>
    <div class="stat-card stat-card--blue">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <div class="stat-card__value">${s.messages.toLocaleString()}</div>
      <div class="stat-card__label">Total_Transmissions</div>
      <div class="stat-card__sub">${s.msg_today} today</div>
    </div>
    <div class="stat-card stat-card--warn">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      <div class="stat-card__value">${s.rooms}</div>
      <div class="stat-card__label">Active_Channels</div>
      <div class="stat-card__sub">${s.agents} AI agents</div>
    </div>
    <div class="stat-card stat-card--live">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <div class="stat-card__value">${s.active_today}</div>
      <div class="stat-card__label">Active_Today</div>
      <div class="stat-card__sub">${s.invites_pending} invites pending</div>
    </div>`;

  const tbody = document.getElementById('recentBody');
  tbody.innerHTML = usersData.users.map(u => `
    <tr>
      <td>
        <span class="td-primary">${u.display_name}</span>
        <span class="td-secondary">@${u.username}</span>
      </td>
      <td><span class="t-badge t-badge--${u.role}">${u.role}</span></td>
      <td class="td-meta">${formatTime(u.last_seen)}</td>
      <td class="td-mono">${u.message_count}</td>
    </tr>`).join('');
}

// ── Users ─────────────────────────────────────────
async function loadUsers() {
  const data = await Auth.api('/api/admin/users');
  if (!data) return;
  allUsers = data.users;
  document.getElementById('userCount').textContent = `${allUsers.length} nodes registered`;
  renderUsers(allUsers);
}

function renderUsers(users) {
  const me = Auth.getUser();
  document.getElementById('usersBody').innerHTML = users.map(u => `
    <tr onclick="openPermsPanel(${u.id}, '${u.username}')" class="u-pointer">
      <td>
        <span class="td-primary">${u.display_name}</span>
        <span class="td-secondary">@${u.username}</span>
        ${u.invited_by_name ? `<span class="td-secondary u-dim">invited by @${u.invited_by_name}</span>` : ''}
      </td>
      <td>
        ${u.id === me.id
          ? `<span class="t-badge t-badge--${u.role}">${u.role}</span>`
          : `<select class="inline-select" onchange="changeRole(${u.id}, this.value)">
              <option value="admin"  ${u.role==='admin'  ? 'selected':''}>ADMIN</option>
              <option value="user"   ${u.role==='user'   ? 'selected':''}>USER</option>
              <option value="agent"  ${u.role==='agent'  ? 'selected':''}>AGENT</option>
            </select>`
        }
      </td>
      <td>
        <span class="t-status t-status--${u.is_online ? 'online' : 'offline'}">
          <span class="t-status__dot"></span>
          ${u.is_online ? 'Online' : 'Offline'}
        </span>
      </td>
      <td class="td-mono">${u.message_count}</td>
      <td class="td-meta">${formatDate(u.created_at)}</td>
      <td>
        ${u.id !== me.id ? `<button class="t-btn t-btn--accent" onclick="editDisplayName(${u.id}, '${u.display_name.replace(/'/g, "\\'")}')">Edit_Name</button>` : '—'}
      </td>
    </tr>`).join('');
}

function filterUsers() {
  const q = document.getElementById('userSearch').value.toLowerCase();
  renderUsers(allUsers.filter(u => u.username.includes(q) || u.display_name.toLowerCase().includes(q)));
}

async function changeRole(userId, newRole) {
  const data = await Auth.api(`/api/admin/users/${userId}`, { method: 'PUT', body: JSON.stringify({ role: newRole }) });
  if (data && !data.error) toast(`Role updated: ${data.user.username} → ${newRole}`);
  else toast('Update failed');
}

async function editDisplayName(userId, currentName) {
  const newName = await showPrompt('New display name:', currentName, { title: 'Edit_Name' });
  if (!newName || newName.trim() === currentName) return;
  const data = await Auth.api(`/api/admin/users/${userId}`, { method: 'PUT', body: JSON.stringify({ display_name: newName.trim() }) });
  if (data && !data.error) { toast('Name updated'); loadUsers(); }
}

// ── Invites ───────────────────────────────────────
async function loadInvites() {
  const data = await Auth.api('/api/admin/invites');
  if (!data) return;

  document.getElementById('invitesBody').innerHTML = data.invites.length === 0
    ? '<tr><td colspan="7" class="empty-state">No access codes found</td></tr>'
    : data.invites.map(inv => `
    <tr>
      <td><span class="invite-code" onclick="copyCode('${inv.code}')" title="Click to copy">${inv.code}</span></td>
      <td class="td-meta">${inv.created_by_name || '—'}</td>
      <td class="td-meta" title="${inv.created_at || ''}">${inv.created_at ? formatDate(inv.created_at) : '—'}</td>
      <td>${inv.used_by_name
        ? `<span class="td-primary">${inv.used_by_display}</span><span class="td-secondary">@${inv.used_by_name}</span>`
        : '<span class="td-empty">—</span>'}</td>
      <td class="td-meta">${inv.expires_at ? formatDate(inv.expires_at) : 'No_Expiry'}</td>
      <td>${inv.used_by
        ? '<span class="t-badge t-badge--used">✓ Claimed</span>'
        : '<span class="t-badge t-badge--active">● Active</span>'}</td>
      <td>${!inv.used_by ? `<button type="button" class="t-btn t-btn--danger" onclick="revokeInvite(${inv.id})">Revoke</button>` : ''}</td>
    </tr>`).join('');
}

async function generateInvite() {
  const data = await Auth.api('/api/admin/invites', { method: 'POST', body: JSON.stringify({}) });
  if (data && data.code) {
    toast(`Code generated: ${data.code} (copied)`);
    navigator.clipboard.writeText(data.code).catch(() => {});
    loadInvites();
  }
}

async function revokeInvite(id) {
  if (!(await showConfirm('Revoke this access code?', { destructive: true, okLabel: 'Revoke' }))) return;
  const numId = parseInt(id, 10);
  if (Number.isNaN(numId)) { toast('Invalid code'); return; }
  const token = Auth.getToken();
  if (!token) { toast('Session expired'); return; }
  try {
    const res = await fetch(`/api/admin/invites/${numId}`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
    });
    if (res.ok) {
      toast('Code revoked');
      loadInvites();
      return;
    }
    const data = await res.json().catch(() => ({}));
    toast(data.error || 'Failed to revoke');
    if (res.status === 401) Auth.logout();
  } catch (e) {
    toast('Failed to revoke');
  }
}

function copyCode(code) {
  navigator.clipboard.writeText(code).then(() => toast(`Copied: ${code}`));
}

// ── Rooms ─────────────────────────────────────────
(function initRoomsTableDelegation() {
  document.getElementById('roomsBody').addEventListener('click', function (e) {
    const btn = e.target.closest('button[data-room-action]');
    if (!btn) return;
    const row = btn.closest('tr');
    if (!row || !row.dataset.roomId) return;
    const id = parseInt(row.dataset.roomId, 10);
    const name = row.dataset.roomName || '';
    const desc = row.dataset.roomDesc || '';
    const type = row.dataset.roomType || 'group';
    const action = btn.dataset.roomAction;
    if (action === 'edit') openEditRoom(id, name, desc, type);
    else if (action === 'members') openMembersPanel(id, name);
    else if (action === 'delete') deleteRoom(id, name);
  });
})();

async function loadRooms() {
  const data = await Auth.api('/api/admin/conversations');
  if (!data) return;
  allRooms = data.rooms;
  renderRooms(allRooms);
}

function renderRooms(rooms) {
  const typeLabel = { direct: 'Direct', group: 'Group', channel: 'Channel' };
  const escape = (s) => (s == null ? '' : String(s)).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
  document.getElementById('roomsBody').innerHTML = rooms.length === 0
    ? '<tr><td colspan="7" class="empty-state">No nodes found</td></tr>'
    : rooms.map(r => {
        const nameAttr = escape(r.name);
        const descAttr = escape(r.description || '');
        return `
    <tr data-room-id="${r.id}" data-room-name="${nameAttr}" data-room-desc="${descAttr}" data-room-type="${r.type || 'group'}"${r.is_archived ? ' style="opacity:0.55"' : ''}>
      <td>
        <span class="td-primary">${escape(r.name)}</span>
        ${r.description ? `<span class="td-secondary">${escape(r.description)}</span>` : ''}
      </td>
      <td><span class="t-badge t-badge--type">${typeLabel[r.type]||r.type}</span></td>
      <td class="td-mono">${r.member_count}</td>
      <td class="td-mono">${r.message_count}</td>
      <td class="td-meta">${r.last_message ? formatTime(r.last_message_at) : '—'}</td>
      <td>${r.is_archived
        ? '<span class="t-badge t-badge--archived">Archived</span>'
        : '<span class="t-badge t-badge--active">● Active</span>'}</td>
      <td style="white-space:nowrap">
        <button type="button" class="t-btn t-btn--sm" data-room-action="edit">Edit</button>
        <button type="button" class="t-btn t-btn--sm" data-room-action="members">Members</button>
        ${r.type !== 'direct' ? '<button type="button" class="t-btn t-btn--sm t-btn--reject" data-room-action="delete">Delete</button>' : ''}
      </td>
    </tr>`;
      }).join('');
}

function filterRooms() {
  const q = document.getElementById('roomSearch').value.toLowerCase();
  renderRooms(allRooms.filter(r => r.name.toLowerCase().includes(q)));
}

// ── Export ────────────────────────────────────────
async function loadExport() {
  const data = await Auth.api('/api/admin/conversations');
  if (!data) return;

  document.getElementById('exportBody').innerHTML = data.rooms.map(r => `
    <tr>
      <td><span class="td-primary">${r.name}</span></td>
      <td><span class="t-badge t-badge--type">${r.type}</span></td>
      <td class="td-mono">${r.message_count}</td>
      <td class="td-mono">${r.member_count}</td>
      <td>
        <a href="/api/admin/export/${r.id}" download
           onclick="addAuthHeader(event, ${r.id})"
           class="t-btn t-btn--accent">⬇ Export_JSON</a>
      </td>
    </tr>`).join('');
}

async function addAuthHeader(e, roomId) {
  e.preventDefault();
  const token = Auth.getToken();
  const res = await fetch(`/api/admin/export/${roomId}`, { headers: { Authorization: `Bearer ${token}` } });
  const blob = await res.blob();
  const fname = res.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || `export-${roomId}.json`;
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fname; a.click();
  URL.revokeObjectURL(url);
  toast(`Downloaded: ${fname}`);
}

// ── Permissions Panel ─────────────────────────────
let currentPermUserId = null;

async function openPermsPanel(userId, username) {
  currentPermUserId = userId;
  document.getElementById('permsPanelTitle').textContent = `Permissions: ${username}`;
  document.getElementById('permsPanelBody').innerHTML = '<div class="u-dim">Loading...</div>';
  document.getElementById('permsPanel').classList.add('open');
  document.getElementById('permsOverlay').classList.add('open');

  // Ensure allUsers is populated (needed for agent checkboxes in renderPermsPanel)
  if (allUsers.length === 0) await loadUsers().catch(() => {});

  const data = await Auth.api(`/api/admin/users/${userId}/permissions`);
  if (!data) return;
  renderPermsPanel(data.permissions);
}

function renderPermsPanel(p) {
  const agents = allUsers.filter(u => u.role === 'agent');
  document.getElementById('permsPanelBody').innerHTML = `
    <div>
      <div class="perms-section-label perms-section-label--spaced">FILE_PERMISSIONS</div>
      <div class="perm-row">
        <span class="perm-row__label">can_send_files</span>
        <input type="checkbox" class="perm-toggle" id="perm_files" ${p.can_send_files ? 'checked' : ''}>
      </div>
    </div>
    <div>
      <div class="perms-section-label">MESSAGE_LIMITS</div>
      <div class="perm-row">
        <span class="perm-row__label">max_messages_per_day</span>
        <input type="number" class="perm-number-input" id="perm_maxmsg" placeholder="∞" value="${p.max_messages_per_day ?? ''}">
      </div>
    </div>
    <div>
      <div class="perms-section-label">AI_ACCESS</div>
      ${agents.length === 0 ? '<div class="u-dim">No AI agents configured.</div>' : agents.map(a => `
        <div class="perm-row">
          <span class="perm-row__label">${a.display_name}</span>
          <input type="checkbox" class="perm-toggle perm-agent" data-agent-id="${a.id}"
            ${(p.allowed_agents || []).includes(a.id) ? 'checked' : ''}>
        </div>
      `).join('')}
    </div>
  `;
}

async function savePermissions() {
  if (!currentPermUserId) return;
  const canSendFiles = document.getElementById('perm_files').checked;
  const maxMsg = document.getElementById('perm_maxmsg').value;
  const agentCheckboxes = document.querySelectorAll('.perm-agent');
  const allowedAgents = [...agentCheckboxes].filter(c => c.checked).map(c => parseInt(c.dataset.agentId));

  const payload = {
    can_send_files: canSendFiles,
    allowed_agents: allowedAgents,
    max_messages_per_day: maxMsg ? parseInt(maxMsg) : null,
  };

  const data = await Auth.api(`/api/admin/users/${currentPermUserId}/permissions`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
  if (data) { toast('Permissions saved'); closePermsPanel(); }
}

function closePermsPanel() {
  document.getElementById('permsPanel').classList.remove('open');
  document.getElementById('permsOverlay').classList.remove('open');
  currentPermUserId = null;
}

// ── Invite Wizard ────────────────────────────────
function openInviteModal() {
  const agents = allUsers.filter(u => u.role === 'agent');
  document.getElementById('inv_agents_section').innerHTML = agents.length === 0
    ? '<div class="u-dim no-agents-msg">No AI agents configured.</div>'
    : '<div class="ai-access-label">AI_ACCESS</div>' +
      agents.map(a => `
        <div class="perm-row">
          <span class="perm-row__label">${a.display_name}</span>
          <input type="checkbox" class="perm-toggle inv-agent" data-agent-id="${a.id}">
        </div>
      `).join('');
  document.getElementById('inviteNote').value = '';
  document.getElementById('inviteModal').classList.add('open');
  applyInvitePreset('standard');
}

function closeInviteModal() {
  document.getElementById('inviteModal').classList.remove('open');
}

function applyInvitePreset(preset) {
  const agents = document.querySelectorAll('.inv-agent');
  const filesToggle = document.getElementById('inv_files');
  if (preset === 'guest') { filesToggle.checked = false; agents.forEach(a => a.checked = false); }
  else if (preset === 'standard') { filesToggle.checked = true; agents.forEach(a => a.checked = false); }
  else if (preset === 'ai') { filesToggle.checked = true; agents.forEach(a => a.checked = true); }
}

async function generateInviteWithPerms() {
  const canSendFiles = document.getElementById('inv_files').checked;
  const agentCheckboxes = document.querySelectorAll('.inv-agent');
  const allowedAgents = [...agentCheckboxes].filter(c => c.checked).map(c => parseInt(c.dataset.agentId));
  const note = document.getElementById('inviteNote').value.trim();

  const data = await Auth.api('/api/admin/invites', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      note: note || null,
      default_permissions: { can_send_files: canSendFiles, allowed_agents: allowedAgents },
    }),
  });
  if (data) {
    closeInviteModal();
    toast(`Code generated: ${data.code}`);
    loadInvites();
  }
}

// ── Channel Management ────────────────────────────
let roomModalId = null;    // null = create, number = edit
let allUsersForRoom = [];  // cached user list for room modal

async function openCreateRoom() {
  roomModalId = null;
  document.getElementById('roomModalTitle').textContent = 'New_Node';
  document.getElementById('roomModalName').value = '';
  document.getElementById('roomModalDesc').value = '';
  document.getElementById('roomModalArchivedWrap').classList.remove('room-modal-archived-wrap--visible');
  document.getElementById('roomModalTypeWrap').style.display = '';
  document.getElementById('roomModalType').value = 'channel';
  document.getElementById('roomModalError').style.display = 'none';
  document.getElementById('roomModalMemberSearch').value = '';
  if (allUsersForRoom.length === 0) {
    const d = await Auth.api('/api/rooms/users/list');
    if (d) allUsersForRoom = d.users;
  }
  renderRoomModalUsers(allUsersForRoom, []);
  document.getElementById('roomModal').classList.add('open');
  document.getElementById('roomModalName').focus();
}

async function openEditRoom(id, name, desc, type) {
  roomModalId = id;
  const typeLabel = type === 'group' ? 'Group' : type === 'channel' ? 'Channel' : 'Node';
  document.getElementById('roomModalTitle').textContent = `Edit_${typeLabel}`;
  document.getElementById('roomModalName').value = name;
  document.getElementById('roomModalDesc').value = desc || '';
  document.getElementById('roomModalArchivedWrap').classList.add('room-modal-archived-wrap--visible');
  document.getElementById('roomModalTypeWrap').style.display = 'none';
  document.getElementById('roomModalError').style.display = 'none';
  document.getElementById('roomModalMemberSearch').value = '';
  if (allUsersForRoom.length === 0) {
    const d = await Auth.api('/api/rooms/users/list');
    if (d) allUsersForRoom = d.users;
  }
  // Load current members and archived state
  const roomData = await Auth.api(`/api/rooms/${id}`);
  if (!roomData || !roomData.room) {
    toast(roomData && roomData.error ? roomData.error : 'Could not load channel.');
    return;
  }
  const currentMemberIds = roomData.members ? roomData.members.map(m => m.id) : [];
  document.getElementById('roomModalArchived').checked = !!(roomData.room && roomData.room.is_archived);
  renderRoomModalUsers(allUsersForRoom, currentMemberIds);
  document.getElementById('roomModal').classList.add('open');
  document.getElementById('roomModalName').focus();
}

function renderRoomModalUsers(users, checkedIds) {
  document.getElementById('roomModalUserList').innerHTML = users.map(u => `
    <label style="display:flex;align-items:center;gap:var(--sp-2);padding:var(--sp-1) var(--sp-2);cursor:pointer;">
      <input type="checkbox" data-uid="${u.id}" ${checkedIds.includes(u.id) ? 'checked' : ''}>
      <span>${u.display_name || u.username}</span>
      <span class="u-dim" style="font-size:var(--font-xs)">@${u.username}</span>
    </label>
  `).join('');
}

function filterRoomModalUsers() {
  const q = document.getElementById('roomModalMemberSearch').value.toLowerCase();
  const filtered = allUsersForRoom.filter(u =>
    (u.display_name || u.username).toLowerCase().includes(q) || u.username.toLowerCase().includes(q)
  );
  const checkedIds = [...document.querySelectorAll('#roomModalUserList input[type=checkbox]:checked')].map(c => parseInt(c.dataset.uid));
  renderRoomModalUsers(filtered, checkedIds);
}

async function saveRoom() {
  const name = document.getElementById('roomModalName').value.trim();
  const desc = document.getElementById('roomModalDesc').value.trim();
  const memberIds = [...document.querySelectorAll('#roomModalUserList input[type=checkbox]:checked')].map(c => parseInt(c.dataset.uid));
  const errEl = document.getElementById('roomModalError');

  if (!name) { errEl.textContent = 'Name required.'; errEl.style.display = ''; return; }
  errEl.style.display = 'none';

  if (roomModalId) {
    // Edit: update name/desc/archived, then reconcile members
    const isArchived = document.getElementById('roomModalArchived').checked;
    const d = await Auth.api(`/api/rooms/${roomModalId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description: desc || null, is_archived: isArchived }),
    });
    if (!d) return;
    // Get current members and add/remove as needed
    const roomData = await Auth.api(`/api/rooms/${roomModalId}`);
    if (roomData) {
      const currentIds = roomData.members.map(m => m.id);
      const toAdd = memberIds.filter(id => !currentIds.includes(id));
      const toRemove = currentIds.filter(id => !memberIds.includes(id));
      for (const uid of toAdd) {
        await Auth.api(`/api/rooms/${roomModalId}/members`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: uid }) });
      }
      for (const uid of toRemove) {
        await Auth.api(`/api/rooms/${roomModalId}/members/${uid}`, { method: 'DELETE' });
      }
    }
    toast('Node updated');
  } else {
    // Create
    const d = await Auth.api('/api/rooms', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description: desc || undefined, type: document.getElementById('roomModalType').value, member_ids: memberIds }),
    });
    if (!d || d.error) { errEl.textContent = d?.error || 'Error creating node.'; errEl.style.display = ''; return; }
    toast('Node created');
  }
  closeRoomModal();
  loadRooms();
}

function closeRoomModal() {
  document.getElementById('roomModal').classList.remove('open');
  roomModalId = null;
}

// ── Members Panel ─────────────────────────────────
let membersPanelRoomId = null;
let allUsersForMembers = [];

async function openMembersPanel(roomId, name) {
  membersPanelRoomId = roomId;
  document.getElementById('membersPanelTitle').textContent = `Members — ${name}`;
  document.getElementById('membersPanelBody').innerHTML = '<div class="u-dim">Loading...</div>';
  document.getElementById('membersPanel').classList.add('open');
  document.getElementById('membersOverlay').classList.add('open');
  document.getElementById('addMemberSearch').value = '';
  document.getElementById('addMemberDropdown').style.display = 'none';

  if (allUsersForMembers.length === 0) {
    const d = await Auth.api('/api/rooms/users/list');
    if (d) allUsersForMembers = d.users;
  }

  await renderMembersPanel();
}

async function renderMembersPanel() {
  const data = await Auth.api(`/api/rooms/${membersPanelRoomId}`);
  if (!data || !data.members) {
    if (data && data.error) toast(data.error);
    else toast('Could not load members.');
    document.getElementById('membersPanelBody').innerHTML = '<div class="u-dim">Failed to load.</div>';
    return;
  }
  const roleLabel = { owner: 'owner', member: 'member', agent: 'agent' };
  document.getElementById('membersPanelBody').innerHTML = data.members.length === 0
    ? '<div class="u-dim">No members.</div>'
    : data.members.map(m => `
      <div class="perm-row">
        <span class="perm-row__label">
          ${m.display_name || m.username}
          <span class="u-dim" style="font-size:var(--font-xs);margin-left:var(--sp-1)">${roleLabel[m.room_role] || m.room_role}</span>
        </span>
        <button class="t-btn t-btn--sm t-btn--reject" onclick="removeRoomMember(${m.id})" title="Remove">✕</button>
      </div>
    `).join('');
}

async function removeRoomMember(userId) {
  const d = await Auth.api(`/api/rooms/${membersPanelRoomId}/members/${userId}`, { method: 'DELETE' });
  if (d) { await renderMembersPanel(); loadRooms(); }
}

function filterAddMemberList() {
  const q = document.getElementById('addMemberSearch').value.toLowerCase().trim();
  const dd = document.getElementById('addMemberDropdown');
  if (!q) { dd.style.display = 'none'; return; }
  const filtered = allUsersForMembers.filter(u =>
    (u.display_name || u.username).toLowerCase().includes(q) || u.username.toLowerCase().includes(q)
  );
  if (filtered.length === 0) { dd.style.display = 'none'; return; }
  dd.style.display = '';
  dd.innerHTML = filtered.slice(0, 8).map(u => `
    <div class="perm-row" style="cursor:pointer;padding:var(--sp-2);" onclick="addRoomMember(${u.id})">
      ${u.display_name || u.username} <span class="u-dim" style="font-size:var(--font-xs)">@${u.username}</span>
    </div>
  `).join('');
}

async function addRoomMember(userId) {
  document.getElementById('addMemberDropdown').style.display = 'none';
  document.getElementById('addMemberSearch').value = '';
  const d = await Auth.api(`/api/rooms/${membersPanelRoomId}/members`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: userId }),
  });
  if (d) { await renderMembersPanel(); loadRooms(); }
}

function closeMembersPanel() {
  document.getElementById('membersPanel').classList.remove('open');
  document.getElementById('membersOverlay').classList.remove('open');
  membersPanelRoomId = null;
}

async function deleteRoom(id, name) {
  if (!(await showConfirm('Delete channel "' + name + '"? This cannot be undone.', { destructive: true, okLabel: 'Delete' }))) return;
  const d = await Auth.api('/api/rooms/' + encodeURIComponent(id), { method: 'DELETE' });
  if (d) { toast('Channel "' + name + '" deleted'); loadRooms(); }
}

async function deleteRoomByNodeId() {
  const name = document.getElementById('deleteByNodeIdInput').value.trim();
  if (!name) { showAlert('Enter a Node_ID to delete.'); return; }
  if (!(await showConfirm('Delete node "' + name + '"? This cannot be undone.', { destructive: true, okLabel: 'Delete' }))) return;
  const d = await Auth.api('/api/rooms/' + encodeURIComponent(name), { method: 'DELETE' });
  if (d) {
    toast('Node "' + name + '" deleted');
    loadRooms();
    document.getElementById('deleteByNodeIdInput').value = '';
  } else {
    showAlert('Node not found or delete failed.');
  }
}

// ── Neural Search ────────────────────────────────
async function runSearch() {
  const q = document.getElementById('searchQuery').value.trim();
  const col = document.getElementById('searchCollection').value;
  if (!q) return;
  document.getElementById('searchResultsContainer').innerHTML = '<div class="u-dim">Searching neural network...</div>';

  const data = await Auth.api(`/api/admin/search?q=${encodeURIComponent(q)}&collection=${col}`);
  if (!data) return;
  if (!data.results || data.results.length === 0) {
    document.getElementById('searchResultsContainer').innerHTML = '<div class="u-dim">No results found.</div>';
    return;
  }

  document.getElementById('searchResultsContainer').innerHTML = data.results.map(r => `
    <div class="search-result">
      <div class="search-result__meta">
        <span class="badge badge--${r.collection === 'messages' ? 'approved' : 'pending'}">${r.collection}</span>
        ${r.metadata.sender ? `<span class="td-meta">${r.metadata.sender}</span>` : ''}
        ${r.metadata.ts ? `<span class="td-meta">${formatTime(r.metadata.ts)}</span>` : ''}
        <span class="search-score">score: ${(r.score * 100).toFixed(0)}%</span>
      </div>
      <div class="search-result__text">${r.text}</div>
    </div>
  `).join('');
}

// ── API Helpers ──────────────────────────────────
async function apiGet(path) {
  const token = localStorage.getItem('one21_token');
  const r = await fetch(path, { headers: { 'Authorization': 'Bearer ' + token } });
  return r.json();
}
async function apiPost(path, body) {
  const token = localStorage.getItem('one21_token');
  const r = await fetch(path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify(body)
  });
  if (!r.ok) { const e = await r.json(); throw new Error(e.error || 'Error'); }
  return r.json();
}
async function apiPut(path, body) {
  const token = localStorage.getItem('one21_token');
  const r = await fetch(path, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify(body)
  });
  if (!r.ok) { const e = await r.json(); throw new Error(e.error || 'Error'); }
  return r.json();
}

// ── SETTINGS ────────────────────────────────────────────

document.querySelectorAll('.settings-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('settings-tab-' + tab.dataset.tab).classList.add('active');
  });
});

async function loadSettings() {
  try {
    const data = await apiGet('/api/admin/settings');
    const input = document.getElementById('claudeApiKeyInput');
    const status = document.getElementById('apiKeyStatus');
    if (data.has_key) {
      input.placeholder = data.claude_api_key;
      status.textContent = 'Key configured ✓';
      status.style.color = 'var(--online)';
    } else {
      status.textContent = 'No key configured';
      status.style.color = 'var(--text-tertiary)';
    }
  } catch(e) {
    console.error('loadSettings error', e);
  }
}

async function saveApiKey() {
  const val = document.getElementById('claudeApiKeyInput').value.trim();
  if (!val) return;
  const status = document.getElementById('apiKeyStatus');
  try {
    await apiPut('/api/admin/settings', { claude_api_key: val });
    status.textContent = 'Saved ✓';
    status.style.color = 'var(--online)';
    document.getElementById('claudeApiKeyInput').value = '';
    await loadSettings();
  } catch(e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = 'var(--error)';
  }
}

// ── THEMES LIST ──────────────────────────────────────────

async function loadThemes() {
  const container = document.getElementById('themesList');
  if (!container) return;
  try {
    const data = await apiGet('/api/admin/themes');
    if (!data.themes || !data.themes.length) {
      container.innerHTML = '<div style="color:var(--text-secondary);font-family:var(--font-mono);font-size:var(--font-sm);padding:var(--sp-4)">No themes</div>';
      return;
    }
    container.innerHTML = data.themes.map(t => `
      <div class="themes-list__item ${t.is_active ? 'themes-list__item--active' : ''}">
        <div class="themes-list__info">
          <span class="themes-list__name">${t.name}</span>
          ${t.is_active ? '<span class="badge badge--accent">Active</span>' : ''}
        </div>
        <div class="themes-list__actions">
          ${!t.is_active ? `<button class="btn btn--ghost btn--sm" onclick="activateTheme(${t.id})">Activate</button>` : ''}
          <button class="btn btn--ghost btn--sm" onclick="openThemeEditor(${t.id})">Edit</button>
          ${!t.is_active ? `<button class="btn btn--danger btn--sm" onclick="deleteTheme(${t.id})">Delete</button>` : ''}
        </div>
      </div>
    `).join('');
  } catch(e) {
    container.innerHTML = '<div style="color:var(--error);font-family:var(--font-mono);font-size:var(--font-sm);padding:var(--sp-4)">Failed to load</div>';
  }
}

async function activateTheme(id) {
  try {
    await apiPost('/api/admin/themes/' + id + '/activate', {});
    await loadThemes();
  } catch(e) { showAlert('Error: ' + e.message); }
}

async function deleteTheme(id) {
  if (!(await showConfirm('Delete this theme?', { destructive: true, okLabel: 'Delete' }))) return;
  try {
    const token = localStorage.getItem('one21_token');
    await fetch('/api/admin/themes/' + id, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    await loadThemes();
  } catch(e) { showAlert('Error: ' + e.message); }
}

// ── THEME EDITOR ─────────────────────────────────────────

let editorThemeId = null;
let editorTokens = {};
let editorTokensBeforeUndo = null;
let themeChatHistory = [];
let lastRawSuggestionText = null;

async function openThemeEditor(id) {
  editorThemeId = id;
  editorTokensBeforeUndo = null;
  themeChatHistory = [];
  lastRawSuggestionText = null;
  hideApplyBar();
  document.getElementById('themeChat').innerHTML = '';
  document.getElementById('themeChatInput').value = '';
  document.getElementById('themeEditorOverlay').classList.remove('u-hidden');

  if (id) {
    const data = await apiGet('/api/admin/themes/' + id);
    editorTokens = data.theme.tokens;
    document.getElementById('themeEditorName').value = data.theme.name;
  } else {
    const cssText = await fetch('/api/theme/active.css').then(r => r.text());
    editorTokens = parseCssTokens(cssText);
    document.getElementById('themeEditorName').value = 'New Theme';
  }

  renderTokens();
  updateIframePreview();
  // Retry once after a short delay so preview shows even if iframe was still loading when we opened
  setTimeout(updateIframePreview, 150);
  const preview = document.querySelector('#themeEditorOverlay .theme-editor__preview');
  if (preview) {
    const saved = localStorage.getItem('themeEditorTokensHeight');
    if (saved) preview.style.setProperty('--theme-tokens-height', saved + 'px');
  }
  const undoBtn = document.getElementById('btnThemeUndo');
  if (undoBtn) undoBtn.disabled = true;
  appendChatMessage('claude', 'Current theme: ' + Object.keys(editorTokens).length + ' tokens. Describe what you want — e.g. "red accent", "light theme", "cyberpunk palette", "gradients and glow", or any creative direction.');
}

function closeThemeEditor() {
  document.getElementById('themeEditorOverlay').classList.add('u-hidden');
  editorThemeId = null;
  editorTokens = {};
  editorTokensBeforeUndo = null;
  themeChatHistory = [];
  lastRawSuggestionText = null;
  hideApplyBar();
}

function themeEditorUndo() {
  if (!editorTokensBeforeUndo) return;
  editorTokens = editorTokensBeforeUndo;
  editorTokensBeforeUndo = null;
  renderTokens();
  updateIframePreview();
  const btn = document.getElementById('btnThemeUndo');
  if (btn) btn.disabled = true;
}

function themeEditorExport() {
  const name = (document.getElementById('themeEditorName').value.trim() || 'theme').replace(/[^a-zA-Z0-9_-]/g, '_');
  const blob = new Blob([JSON.stringify({ name: name || 'theme', tokens: editorTokens }, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (name || 'theme') + '.theme.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

function themeEditorFullscreenPreview() {
  const w = window.open('/login.html', 'themePreview', 'noopener,resizable,scrollbars');
  if (!w) return;
  const vars = Object.entries(editorTokens).map(([k, v]) => k + ':' + v).join(';');
  const inject = function() {
    try {
      const style = w.document.createElement('style');
      style.id = 'preview-theme-override';
      style.textContent = '@layer tokens { :root { ' + vars.replace(/;/g, '; ') + ' } }';
      w.document.head.appendChild(style);
    } catch (e) {}
  };
  w.addEventListener('load', inject);
  setTimeout(inject, 800);
}

async function saveTheme() {
  const name = document.getElementById('themeEditorName').value.trim();
  if (!name) { showAlert('Theme name required'); return; }
  try {
    if (editorThemeId) {
      await apiPut('/api/admin/themes/' + editorThemeId, { name, tokens: editorTokens });
    } else {
      await apiPost('/api/admin/themes', { name, tokens: editorTokens });
    }
    closeThemeEditor();
    await loadThemes();
  } catch(e) { showAlert('Save failed: ' + e.message); }
}

function showSaveAsNew() {
  const input = document.getElementById('newThemeNameInput');
  input.value = '';
  document.getElementById('saveAsNewOverlay').classList.add('open');
  setTimeout(() => input.focus(), 50);
}

function hideSaveAsNew() {
  document.getElementById('saveAsNewOverlay').classList.remove('open');
}

async function confirmSaveAsNew() {
  const name = document.getElementById('newThemeNameInput').value.trim();
  if (!name) { document.getElementById('newThemeNameInput').focus(); return; }
  try {
    await apiPost('/api/admin/themes', { name, tokens: editorTokens });
    hideSaveAsNew();
    closeThemeEditor();
    await loadThemes();
  } catch(e) { showAlert('Save failed: ' + e.message); }
}

async function sendThemeChat() {
  const input = document.getElementById('themeChatInput');
  const message = input.value.trim();
  if (!message) return;
  input.value = '';
  input.disabled = true;

  appendChatMessage('user', message);
  const loadingEl = appendChatMessage('claude', '...');

  try {
    const token = localStorage.getItem('one21_token');
    const r = await fetch('/api/admin/themes/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ message, current_tokens: editorTokens, history: themeChatHistory }),
    });
    const data = await r.json();
    loadingEl.remove();
    if (r.ok) {
      editorTokensBeforeUndo = Object.assign({}, editorTokens);
      lastRawSuggestionText = null;
      hideApplyBar();
      const undoBtn = document.getElementById('btnThemeUndo');
      if (undoBtn) undoBtn.disabled = false;
      appendChatMessage('claude', data.explanation || 'Done.');
      themeChatHistory.push({ role: 'user', content: message });
      themeChatHistory.push({ role: 'assistant', content: data.explanation || 'Done.' });
      const maxHistory = 20;
      if (themeChatHistory.length > maxHistory) themeChatHistory = themeChatHistory.slice(-maxHistory);
      editorTokens = data.tokens;
      renderTokens();
      updateIframePreview();
      setTimeout(updateIframePreview, 100);
      scrollToTokensPanel();
    } else if (data.raw) {
      lastRawSuggestionText = data.raw;
      showApplyBar();
      appendChatMessage('claude', data.raw, { rawSuggestion: true });
      appendChatMessage('claude', '↓ Use "Apply suggestion → Preview & tokens" above the chat input to generate the theme and see it in the preview.', { isHint: true });
    } else {
      const errMsg = (data.error || 'Error') + (data.detail ? ': ' + data.detail : '');
      appendChatMessage('error', errMsg);
    }
  } catch(e) {
    loadingEl.remove();
    appendChatMessage('error', 'Error: ' + (e.message || 'Network or server error'));
  }
  input.disabled = false;
  input.focus();
}

function appendChatMessage(role, text, options) {
  const chat = document.getElementById('themeChat');
  const div = document.createElement('div');
  div.className = 'theme-chat-msg theme-chat-msg--' + role + (options && options.isHint ? ' theme-chat-msg--hint' : '');
  const body = document.createElement('div');
  body.className = 'theme-chat-msg__body';
  body.textContent = text;
  div.appendChild(body);
  if (options && options.rawSuggestion) {
    const actions = document.createElement('div');
    actions.className = 'theme-chat-msg__actions';
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn--primary btn--sm';
    btn.textContent = 'Apply suggestion → Preview & tokens';
    btn.addEventListener('click', function() {
      applySuggestionToPreview(text);
      btn.disabled = true;
      btn.textContent = 'Applying…';
    });
    actions.appendChild(btn);
    div.appendChild(actions);
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function scrollToTokensPanel() {
  const el = document.getElementById('themeTokensBlock');
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showApplyBar() {
  const bar = document.getElementById('themeApplyBar');
  if (bar) bar.classList.remove('u-hidden');
}

function hideApplyBar() {
  const bar = document.getElementById('themeApplyBar');
  if (bar) bar.classList.add('u-hidden');
}

function applyLastSuggestion() {
  if (!lastRawSuggestionText) return;
  const btn = document.getElementById('themeApplyBarBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'Applying…'; }
  applySuggestionToPreview(lastRawSuggestionText).finally(function() {
    if (btn) { btn.disabled = false; btn.textContent = 'Apply suggestion → Preview & tokens'; }
  });
}

async function applySuggestionToPreview(suggestionText) {
  const loadingEl = appendChatMessage('claude', '...');
  const message = 'Convert the following theme description into design tokens. Reply with JSON only: {"tokens":{...},"explanation":"..."}. Include all CSS custom properties (--name: value) needed. Preserve or extend existing token keys where it makes sense.\n\nDescription:\n' + suggestionText.slice(0, 12000);
  try {
    const token = localStorage.getItem('one21_token');
    const r = await fetch('/api/admin/themes/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ message, current_tokens: editorTokens, history: themeChatHistory }),
    });
    const data = await r.json();
    loadingEl.remove();
    if (r.ok) {
      editorTokensBeforeUndo = Object.assign({}, editorTokens);
      const undoBtn = document.getElementById('btnThemeUndo');
      if (undoBtn) undoBtn.disabled = false;
      appendChatMessage('claude', data.explanation || 'Done.');
      themeChatHistory.push({ role: 'user', content: message });
      themeChatHistory.push({ role: 'assistant', content: data.explanation || 'Done.' });
      const maxHistory = 20;
      if (themeChatHistory.length > maxHistory) themeChatHistory = themeChatHistory.slice(-maxHistory);
      editorTokens = data.tokens;
      lastRawSuggestionText = null;
      hideApplyBar();
      renderTokens();
      updateIframePreview();
      setTimeout(updateIframePreview, 100);
      scrollToTokensPanel();
    } else if (data.raw) {
      lastRawSuggestionText = data.raw;
      showApplyBar();
      appendChatMessage('claude', data.raw, { rawSuggestion: true });
      appendChatMessage('claude', '↓ Use "Apply suggestion → Preview & tokens" above the chat input.', { isHint: true });
    } else {
      const errMsg = (data.error || 'Error') + (data.detail ? ': ' + data.detail : '');
      appendChatMessage('error', errMsg);
    }
  } catch (e) {
    loadingEl.remove();
    appendChatMessage('error', 'Error: ' + (e.message || 'Network or server error'));
  }
}

function parseColorToRgb(value) {
  if (!value || typeof value !== 'string') return null;
  const v = value.trim();
  let m = v.match(/^#([0-9a-fA-F]{3})$/);
  if (m) {
    const h = m[1];
    return [parseInt(h[0]+h[0],16), parseInt(h[1]+h[1],16), parseInt(h[2]+h[2],16)];
  }
  m = v.match(/^#([0-9a-fA-F]{6})$/);
  if (m) {
    const h = m[1];
    return [parseInt(h.slice(0,2),16), parseInt(h.slice(2,4),16), parseInt(h.slice(4,6),16)];
  }
  m = v.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/);
  if (m) return [+m[1], +m[2], +m[3]];
  m = v.match(/^rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*[\d.]+\s*\)$/);
  if (m) return [+m[1], +m[2], +m[3]];
  m = v.match(/^hsl\s*\(\s*([\d.]+)\s*,\s*([\d.]+)%\s*,\s*([\d.]+)%\s*\)$/);
  if (m) {
    const h = parseFloat(m[1]) / 360, s = parseFloat(m[2]) / 100, l = parseFloat(m[3]) / 100;
    let r, g, b;
    if (s === 0) { r = g = b = l; } else {
      const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      const p = 2 * l - q;
      r = hue2rgb(p, q, h + 1/3);
      g = hue2rgb(p, q, h);
      b = hue2rgb(p, q, h - 1/3);
    }
    return [Math.round(r*255), Math.round(g*255), Math.round(b*255)];
  }
  m = v.match(/^hsla\s*\(\s*([\d.]+)\s*,\s*([\d.]+)%\s*,\s*([\d.]+)%\s*,\s*[\d.]+\s*\)$/);
  if (m) {
    const h = parseFloat(m[1]) / 360, s = parseFloat(m[2]) / 100, l = parseFloat(m[3]) / 100;
    let r, g, b;
    if (s === 0) { r = g = b = l; } else {
      const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      const p = 2 * l - q;
      r = hue2rgb(p, q, h + 1/3);
      g = hue2rgb(p, q, h);
      b = hue2rgb(p, q, h - 1/3);
    }
    return [Math.round(r*255), Math.round(g*255), Math.round(b*255)];
  }
  return null;
}
function hue2rgb(p, q, t) {
  if (t < 0) t += 1; if (t > 1) t -= 1;
  if (t < 1/6) return p + (q - p) * 6 * t;
  if (t < 1/2) return q;
  if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
  return p;
}
function relativeLuminance(r, g, b) {
  const [rs, gs, bs] = [r, g, b].map(c => {
    c = c / 255;
    return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
  });
  return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
}
function contrastRatio(lum1, lum2) {
  const L1 = Math.max(lum1, lum2);
  const L2 = Math.min(lum1, lum2);
  return (L1 + 0.05) / (L2 + 0.05);
}
function isColorValue(value) {
  if (!value || typeof value !== 'string') return false;
  const v = value.trim();
  return /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) ||
    /^rgb\s*\(/.test(v) || /^rgba\s*\(/.test(v) || /^hsl\s*\(/.test(v) || /^hsla\s*\(/.test(v);
}
function isForegroundToken(key) {
  return /^--text-|^--accent$|^--error$|^--warning$|^--info$|^--danger$|^--online$|^--offline$/.test(key);
}
function getContrastWarning(fgValue, bgValue) {
  const fg = parseColorToRgb(fgValue);
  const bg = parseColorToRgb(bgValue);
  if (!fg || !bg) return null;
  const ratio = contrastRatio(relativeLuminance(...fg), relativeLuminance(...bg));
  return ratio < 4.5 ? 'low' : null;
}
function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}
function escapeAttr(s) {
  if (s == null) return '';
  return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
function sanitizeCssColor(value) {
  if (!value || typeof value !== 'string') return null;
  const v = value.trim();
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v)) return v;
  if (/^rgb\s*\(\s*[\d.]+\s*,\s*[\d.]+\s*,\s*[\d.]+\s*\)$/.test(v)) return v;
  if (/^rgba\s*\(\s*[\d.]+\s*,\s*[\d.]+\s*,\s*[\d.]+\s*,\s*[\d.]+\s*\)$/.test(v)) return v;
  if (/^hsl\s*\(\s*[\d.]+\s*,\s*[\d.]+%\s*,\s*[\d.]+%\s*\)$/.test(v)) return v;
  if (/^hsla\s*\(\s*[\d.]+\s*,\s*[\d.]+%\s*,\s*[\d.]+%\s*,\s*[\d.]+\s*\)$/.test(v)) return v;
  return null;
}
function renderTokens() {
  const container = document.getElementById('themeTokensList');
  if (!container) return;
  const bgBase = editorTokens['--bg-base'] || '#0d0d0d';
  const warnSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/><line x1="12" y1="8" x2="12" y2="12"/></svg>';
  const entries = Object.entries(editorTokens);
  const safeColorValues = [];
  const rules = [];
  entries.forEach(([, v], i) => {
    const safe = sanitizeCssColor(v);
    if (safe) {
      safeColorValues[i] = safe;
      rules.push('.theme-editor__tokens .token-swatch-bg-' + i + '{background:' + safe + '}');
    }
  });
  const styleBlock = rules.length ? '<style id="themeTokensSwatchStyles">' + rules.join('') + '</style>' : '';
  container.innerHTML = styleBlock + entries.map(([k, v], i) => {
    const isColor = isColorValue(v);
    const isFg = isForegroundToken(k);
    const warn = isFg && isColor && getContrastWarning(v, bgBase);
    const swatchClass = isColor && safeColorValues[i] !== undefined ? 'token-row__swatch token-swatch-bg-' + i : 'token-row__swatch';
    const swatch = isColor ? '<span class="' + swatchClass + '" title="' + escapeAttr(v) + '"></span>' : '';
    const warnEl = warn ? '<span class="token-row__contrast-warn" title="Low contrast (WCAG AA)">' + warnSvg + '</span>' : '';
    return '<div class="token-row">' + warnEl + '<span class="token-row__key">' + escapeHtml(k) + '</span>' + swatch + '<span class="token-row__value">' + escapeHtml(v) + '</span></div>';
  }).join('');
}

function updateIframePreview() {
  const iframe = document.getElementById('themePreviewFrame');
  if (!iframe) return;
  const vars = Object.entries(editorTokens).map(([k, v]) => k + ':' + v).join(';');
  try {
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    let styleEl = iframeDoc.getElementById('preview-theme-override');
    if (!styleEl) {
      styleEl = iframeDoc.createElement('style');
      styleEl.id = 'preview-theme-override';
      iframeDoc.head.appendChild(styleEl);
    }
    styleEl.textContent = '@layer tokens { :root { ' + vars.replace(/;/g, '; ') + ' } }';
  } catch(e) {
    // iframe not ready yet; onload will call updateIframePreview again
  }
}

function setupThemePreviewIframe() {
  const iframe = document.getElementById('themePreviewFrame');
  if (!iframe) return;
  iframe.addEventListener('load', function onPreviewLoad() {
    const overlay = document.getElementById('themeEditorOverlay');
    if (overlay && !overlay.classList.contains('u-hidden')) {
      updateIframePreview();
    }
  });
}

function parseCssTokens(css) {
  const tokens = {};
  const matches = css.matchAll(/(--[\w-]+)\s*:\s*([^;]+);/g);
  for (const [, key, value] of matches) {
    tokens[key] = value.trim();
  }
  return tokens;
}

function setupThemeTokensResize() {
  const handle = document.getElementById('themeTokensResize');
  const block = document.getElementById('themeTokensBlock');
  if (!handle || !block) return;
  const preview = block.closest('.theme-editor__preview');
  if (!preview) return;
  const MIN_H = 120;
  const MAX_H = 400;
  let startY = 0;
  let startHeight = 0;
  function onMove(e) {
    const dy = startY - e.clientY;
    const newH = Math.min(MAX_H, Math.max(MIN_H, startHeight + dy));
    preview.style.setProperty('--theme-tokens-height', newH + 'px');
    localStorage.setItem('themeEditorTokensHeight', String(newH));
  }
  function onUp() {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
  }
  handle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    const currentH = block.getBoundingClientRect().height;
    startHeight = currentH > 0 ? currentH : (parseInt(localStorage.getItem('themeEditorTokensHeight'), 10) || 200);
    startY = e.clientY;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

// ── Init ──────────────────────────────────────────
loadOverview();
setupThemeTokensResize();
setupThemePreviewIframe();
</script>
</body>
</html>
