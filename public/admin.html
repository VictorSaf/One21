<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ONE21 — Command Console</title>
<link rel="stylesheet" href="/css/design-system.css">
<link rel="stylesheet" href="/api/theme/active.css">
<link rel="stylesheet" href="/css/layers/pages/admin.css">
</head>
<body>

<div class="admin-layout">

  <!-- ══════════════════════════════════════
       SIDEBAR
       ══════════════════════════════════════ -->
  <nav class="admin-nav">

    <div class="admin-nav__brand">
      <div class="brand-logo">
        <span class="brand-logo__box">ONE</span>
        <span class="brand-logo__suffix">_21</span>
      </div>
      <span class="admin-nav__console-label">CONSOLE</span>
    </div>

    <div class="admin-nav__section">Command_Modules</div>

    <button class="admin-nav__item active" data-page="overview">
      <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Overview
    </button>
    <button class="admin-nav__item" data-page="users">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Node_Registry
    </button>
    <button class="admin-nav__item" data-page="invites">
      <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      Access_Codes
    </button>
    <button class="admin-nav__item" data-page="rooms">
      <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Node_Map
    </button>
    <button class="admin-nav__item" data-page="room-requests">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Room_Requests <span class="nav-badge u-hidden" id="requestsBadge">0</span>
    </button>
    <button class="admin-nav__item" data-page="search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Neural_Search
    </button>
    <button class="admin-nav__item" data-page="export">
      <svg viewBox="0 0 24 24"><polyline points="8 17 12 21 16 17"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"/></svg>
      Data_Export
    </button>
    <button class="admin-nav__item" data-page="settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
      Settings
    </button>

    <div class="admin-nav__footer">
      <button class="admin-nav__footer-btn" onclick="goToChat()">
        <svg viewBox="0 0 24 24"><polyline points="9 10 4 15 9 20"/><path d="M20 4v7a4 4 0 0 1-4 4H4"/></svg>
        Return_To_Chat
      </button>
      <button class="admin-nav__footer-btn admin-nav__footer-btn--danger" onclick="Auth.logout()">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Terminate_Session
      </button>
    </div>

  </nav>


  <!-- ══════════════════════════════════════
       MAIN CONTENT
       ══════════════════════════════════════ -->
  <main class="admin-main">

    <!-- ── OVERVIEW ── -->
    <div class="admin-page active" id="page-overview">

      <div class="admin-page-header">
        <div class="admin-page-label">System_Status</div>
        <div class="admin-page-title">Overview</div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-card__label">Loading...</div>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-section__header">
          <span class="admin-section__title">Recent_Activity</span>
          <button class="t-btn t-btn--accent" onclick="loadOverview()">
            <svg class="icon-svg icon-svg--xs" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Refresh
          </button>
        </div>
        <table id="recentTable">
          <thead>
            <tr>
              <th>Node_ID</th>
              <th>Access_Level</th>
              <th>Last_Transmission</th>
              <th>Msg_Count</th>
            </tr>
          </thead>
          <tbody id="recentBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── USERS ── -->
    <div class="admin-page" id="page-users">

      <div class="admin-page-header">
        <div class="admin-page-label">Access_Control</div>
        <div class="admin-page-title">Node_Registry</div>
      </div>

      <div class="admin-toolbar">
        <input class="admin-toolbar__input" type="text" id="userSearch" placeholder="QUERY_NODE..." oninput="filterUsers()">
        <span class="admin-toolbar__count" id="userCount"></span>
      </div>

      <div class="admin-section">
        <table id="usersTable">
          <thead>
            <tr>
              <th>Node_ID</th>
              <th>Access_Level</th>
              <th>Status</th>
              <th>Msg_Count</th>
              <th>Registered</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── INVITES ── -->
    <div class="admin-page" id="page-invites">

      <div class="admin-page-header">
        <div class="admin-page-label">Access_Management</div>
        <div class="admin-page-title">Access_Codes</div>
      </div>

      <div class="admin-toolbar">
        <button class="t-btn t-btn--accent t-btn--lg" onclick="openInviteModal()">
          <svg class="icon-svg icon-svg--xs" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Generate_New_Code
        </button>
      </div>

      <div class="admin-section">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Issued_By</th>
              <th>Created</th>
              <th>Claimed_By</th>
              <th>Expires</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="invitesBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── ROOM REQUESTS ── -->
    <div class="admin-page" id="page-room-requests">
      <div class="admin-page-header">
        <div class="admin-page-label">Pending_Review</div>
        <div class="admin-page-title">Room_Requests</div>
      </div>
      <div class="admin-section">
        <table>
          <thead>
            <tr>
              <th>Requester</th>
              <th>Room_Name</th>
              <th>Description</th>
              <th>Submitted</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="requestsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ── NEURAL SEARCH ── -->
    <div class="admin-page" id="page-search">
      <div class="admin-page-header">
        <div class="admin-page-label">Semantic_Query</div>
        <div class="admin-page-title">Neural_Search</div>
      </div>
      <div class="admin-toolbar">
        <input class="admin-toolbar__input admin-toolbar__input--grow" type="text" id="searchQuery"
          placeholder="QUERY_NEURAL_NETWORK..." onkeydown="if(event.key==='Enter') runSearch()">
        <select id="searchCollection" class="inline-select">
          <option value="all">All</option>
          <option value="messages">Messages</option>
          <option value="admin_events">Admin Events</option>
        </select>
        <button class="t-btn t-btn--accent" onclick="runSearch()">Search</button>
      </div>
      <div class="admin-section" id="searchResultsContainer">
        <div class="u-dim">Enter a query to search semantically across all interactions.</div>
      </div>
    </div>

    <!-- ── ROOMS ── -->
    <div class="admin-page" id="page-rooms">

      <div class="admin-page-header">
        <div class="admin-page-label">Topology</div>
        <div class="admin-page-title">Node_Map</div>
      </div>

      <div class="admin-toolbar">
        <input class="admin-toolbar__input" type="text" id="roomSearch" placeholder="QUERY_NODE..." oninput="filterRooms()">
      </div>

      <div class="admin-section">
        <table id="roomsTable">
          <thead>
            <tr>
              <th>Node_Name</th>
              <th>Type</th>
              <th>Listeners</th>
              <th>Msg_Count</th>
              <th>Last_Transmission</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="roomsBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── EXPORT ── -->
    <div class="admin-page" id="page-export">

      <div class="admin-page-header">
        <div class="admin-page-label">Data_Operations</div>
        <div class="admin-page-title">Data_Export</div>
      </div>

      <div class="admin-section">
        <div class="admin-section__header">
          <span class="admin-section__title">Select_Node_For_Export</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Node_Name</th>
              <th>Type</th>
              <th>Msg_Count</th>
              <th>Listeners</th>
              <th>Export</th>
            </tr>
          </thead>
          <tbody id="exportBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── SETTINGS ── -->
    <div class="admin-page" id="page-settings">

      <div class="admin-page-header">
        <div class="admin-page-label">System_Config</div>
        <div class="admin-page-title">Settings</div>
      </div>

      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="api-keys">API_Keys</button>
        <button class="settings-tab" data-tab="themes">UI_Themes</button>
      </div>

      <div class="settings-panel active" id="settings-tab-api-keys">
        <div class="admin-section">
          <div class="admin-section__header">
            <span class="admin-section__title">Claude_API_Key</span>
          </div>
          <div class="settings-field">
            <label class="settings-field__label">CLAUDE_API_KEY</label>
            <div class="settings-field__row">
              <input type="password" id="claudeApiKeyInput" class="input" placeholder="sk-ant-••••••••••••••••">
              <button class="btn btn--primary btn--sm" onclick="saveApiKey()">Save</button>
            </div>
            <p class="settings-field__hint" id="apiKeyStatus">—</p>
          </div>
        </div>
      </div>

      <div class="settings-panel" id="settings-tab-themes">
        <div class="admin-section">
          <div class="admin-section__header">
            <span class="admin-section__title">Themes</span>
            <button class="btn btn--primary btn--sm" onclick="openThemeEditor(null)">+ New Theme</button>
          </div>
          <div id="themesList" class="themes-list">
            <div class="themes-list__loading">Loading...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- ── THEME EDITOR MODAL ── -->
    <div class="theme-editor-overlay u-hidden" id="themeEditorOverlay">
      <div class="theme-editor">

        <div class="theme-editor__header">
          <input type="text" class="theme-editor__name" id="themeEditorName" placeholder="Theme name...">
          <div class="theme-editor__actions">
            <button class="btn btn--ghost btn--sm" onclick="closeThemeEditor()">Cancel</button>
            <button class="btn btn--primary btn--sm" onclick="saveTheme()">Save Theme</button>
          </div>
        </div>

        <div class="theme-editor__body">
          <div class="theme-editor__chat">
            <div class="theme-editor__chat-messages" id="themeChat"></div>
            <div class="theme-editor__chat-input">
              <input type="text" id="themeChatInput" placeholder="Descrie modificarea dorita..." onkeydown="if(event.key==='Enter')sendThemeChat()">
              <button class="btn btn--primary btn--sm" onclick="sendThemeChat()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              </button>
            </div>
          </div>
          <div class="theme-editor__preview">
            <div class="theme-editor__preview-label">PREVIEW</div>
            <iframe class="theme-editor__iframe" id="themePreviewFrame" src="/login.html" sandbox="allow-same-origin allow-scripts"></iframe>
            <div class="theme-editor__tokens-label">TOKENS</div>
            <div class="theme-editor__tokens" id="themeTokensList"></div>
          </div>
        </div>

      </div>
    </div>

  </main>

  <!-- ── USER PERMISSIONS PANEL ── -->
  <div class="perms-panel" id="permsPanel">
    <div class="perms-panel__header">
      <span class="perms-panel__title" id="permsPanelTitle">Node_Permissions</span>
      <button class="perms-panel__close" onclick="closePermsPanel()">✕</button>
    </div>
    <div class="perms-panel__body" id="permsPanelBody">
      <div class="u-dim">Select a node to view permissions.</div>
    </div>
    <div class="perms-panel__footer">
      <button class="t-btn t-btn--accent" onclick="savePermissions()">Save_Permissions</button>
      <button class="t-btn" onclick="closePermsPanel()">Cancel</button>
    </div>
  </div>
  <div class="perms-overlay" id="permsOverlay" onclick="closePermsPanel()"></div>

  <!-- ── INVITE WIZARD MODAL ── -->
  <div class="modal-overlay" id="inviteModal">
    <div class="modal">
      <div class="modal__header">
        <span class="modal__title">Generate_Access_Code</span>
        <button class="modal__close" onclick="closeInviteModal()">✕</button>
      </div>
      <div class="modal__body">
        <div class="perm-row">
          <span class="perm-row__label">Preset</span>
          <select id="invitePreset" onchange="applyInvitePreset(this.value)" class="inline-select">
            <option value="guest">Guest (no files, no AI)</option>
            <option value="standard" selected>Standard</option>
            <option value="ai">AI User (all agents)</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div id="inviteCustomPerms" class="invite-custom-perms">
          <div class="perm-row">
            <span class="perm-row__label">can_send_files</span>
            <input type="checkbox" class="perm-toggle" id="inv_files" checked>
          </div>
          <div id="inv_agents_section"></div>
        </div>
        <div class="invite-note-block">
          <div class="perm-row__label invite-note-label">Note (optional)</div>
          <input type="text" id="inviteNote" placeholder="e.g. For marketing team" class="admin-toolbar__input invite-note-input">
        </div>
      </div>
      <div class="modal__footer">
        <button class="t-btn t-btn--accent" onclick="generateInviteWithPerms()">Generate_Code</button>
        <button class="t-btn" onclick="closeInviteModal()">Cancel</button>
      </div>
    </div>
  </div>

</div>


<script src="/js/auth.js"></script>
<script>
// ── Auth guard ──────────────────────────────────
if (!Auth.requireAuth()) {
  const u = Auth.getUser();
  if (u && u.role !== 'admin') {
    alert('Acces restricționat — doar administratori.');
    window.location.href = '/chat.html';
  }
}

let allUsers = [];
let allRooms = [];

// ── Navigation ────────────────────────────────────
document.querySelectorAll('.admin-nav__item[data-page]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.admin-nav__item').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`page-${btn.dataset.page}`).classList.add('active');

    const loaders = { overview: loadOverview, users: loadUsers, invites: loadInvites, rooms: loadRooms, export: loadExport, 'room-requests': loadRoomRequests, 'search': () => {} };
    loaders[btn.dataset.page] && loaders[btn.dataset.page]();
  });
});

function goToChat() { window.location.href = '/chat.html'; }

// ── Toast ─────────────────────────────────────────
function toast(msg, duration = 2500) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), duration);
}

// ── Helpers ───────────────────────────────────────
function formatDate(iso) {
  if (!iso) return '—';
  const d = new Date(iso.includes('T') ? iso : iso.replace(' ', 'T') + 'Z');
  return d.toLocaleDateString('ro-RO', { day: '2-digit', month: 'short', year: 'numeric' });
}
function formatTime(iso) {
  if (!iso) return '—';
  const d = new Date(iso.includes('T') ? iso : iso.replace(' ', 'T') + 'Z');
  return d.toLocaleString('ro-RO', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
}

// ── Overview ──────────────────────────────────────
async function loadOverview() {
  const [statsData, usersData] = await Promise.all([
    Auth.api('/api/admin/stats'),
    Auth.api('/api/admin/users'),
  ]);
  if (!statsData || !usersData) return;

  const s = statsData.stats;
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card stat-card--accent">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
      <div class="stat-card__value">${s.users}</div>
      <div class="stat-card__label">Active_Nodes</div>
      <div class="stat-card__sub">${s.online_now} online now</div>
    </div>
    <div class="stat-card stat-card--blue">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <div class="stat-card__value">${s.messages.toLocaleString()}</div>
      <div class="stat-card__label">Total_Transmissions</div>
      <div class="stat-card__sub">${s.msg_today} today</div>
    </div>
    <div class="stat-card stat-card--warn">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      <div class="stat-card__value">${s.rooms}</div>
      <div class="stat-card__label">Active_Channels</div>
      <div class="stat-card__sub">${s.agents} AI agents</div>
    </div>
    <div class="stat-card stat-card--live">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <div class="stat-card__value">${s.active_today}</div>
      <div class="stat-card__label">Active_Today</div>
      <div class="stat-card__sub">${s.invites_pending} invites pending</div>
    </div>`;

  const tbody = document.getElementById('recentBody');
  tbody.innerHTML = usersData.users.map(u => `
    <tr>
      <td>
        <span class="td-primary">${u.display_name}</span>
        <span class="td-secondary">@${u.username}</span>
      </td>
      <td><span class="t-badge t-badge--${u.role}">${u.role}</span></td>
      <td class="td-meta">${formatTime(u.last_seen)}</td>
      <td class="td-mono">${u.message_count}</td>
    </tr>`).join('');
}

// ── Users ─────────────────────────────────────────
async function loadUsers() {
  const data = await Auth.api('/api/admin/users');
  if (!data) return;
  allUsers = data.users;
  document.getElementById('userCount').textContent = `${allUsers.length} nodes registered`;
  renderUsers(allUsers);
}

function renderUsers(users) {
  const me = Auth.getUser();
  document.getElementById('usersBody').innerHTML = users.map(u => `
    <tr onclick="openPermsPanel(${u.id}, '${u.username}')" class="u-pointer">
      <td>
        <span class="td-primary">${u.display_name}</span>
        <span class="td-secondary">@${u.username}</span>
        ${u.invited_by_name ? `<span class="td-secondary u-dim">invited by @${u.invited_by_name}</span>` : ''}
      </td>
      <td>
        ${u.id === me.id
          ? `<span class="t-badge t-badge--${u.role}">${u.role}</span>`
          : `<select class="inline-select" onchange="changeRole(${u.id}, this.value)">
              <option value="admin"  ${u.role==='admin'  ? 'selected':''}>ADMIN</option>
              <option value="user"   ${u.role==='user'   ? 'selected':''}>USER</option>
              <option value="agent"  ${u.role==='agent'  ? 'selected':''}>AGENT</option>
            </select>`
        }
      </td>
      <td>
        <span class="t-status t-status--${u.is_online ? 'online' : 'offline'}">
          <span class="t-status__dot"></span>
          ${u.is_online ? 'Online' : 'Offline'}
        </span>
      </td>
      <td class="td-mono">${u.message_count}</td>
      <td class="td-meta">${formatDate(u.created_at)}</td>
      <td>
        ${u.id !== me.id ? `<button class="t-btn t-btn--accent" onclick="editDisplayName(${u.id}, '${u.display_name.replace(/'/g, "\\'")}')">Edit_Name</button>` : '—'}
      </td>
    </tr>`).join('');
}

function filterUsers() {
  const q = document.getElementById('userSearch').value.toLowerCase();
  renderUsers(allUsers.filter(u => u.username.includes(q) || u.display_name.toLowerCase().includes(q)));
}

async function changeRole(userId, newRole) {
  const data = await Auth.api(`/api/admin/users/${userId}`, { method: 'PUT', body: JSON.stringify({ role: newRole }) });
  if (data && !data.error) toast(`Role updated: ${data.user.username} → ${newRole}`);
  else toast('Update failed');
}

async function editDisplayName(userId, currentName) {
  const newName = prompt('New display name:', currentName);
  if (!newName || newName.trim() === currentName) return;
  const data = await Auth.api(`/api/admin/users/${userId}`, { method: 'PUT', body: JSON.stringify({ display_name: newName.trim() }) });
  if (data && !data.error) { toast('Name updated'); loadUsers(); }
}

// ── Invites ───────────────────────────────────────
async function loadInvites() {
  const data = await Auth.api('/api/admin/invites');
  if (!data) return;

  document.getElementById('invitesBody').innerHTML = data.invites.length === 0
    ? '<tr><td colspan="7" class="empty-state">No access codes found</td></tr>'
    : data.invites.map(inv => `
    <tr>
      <td><span class="invite-code" onclick="copyCode('${inv.code}')" title="Click to copy">${inv.code}</span></td>
      <td class="td-meta">${inv.created_by_name || '—'}</td>
      <td class="td-meta" title="${inv.created_at || ''}">${inv.created_at ? formatDate(inv.created_at) : '—'}</td>
      <td>${inv.used_by_name
        ? `<span class="td-primary">${inv.used_by_display}</span><span class="td-secondary">@${inv.used_by_name}</span>`
        : '<span class="td-empty">—</span>'}</td>
      <td class="td-meta">${inv.expires_at ? formatDate(inv.expires_at) : 'No_Expiry'}</td>
      <td>${inv.used_by
        ? '<span class="t-badge t-badge--used">✓ Claimed</span>'
        : '<span class="t-badge t-badge--active">● Active</span>'}</td>
      <td>${!inv.used_by ? `<button class="t-btn t-btn--danger" onclick="revokeInvite(${inv.id})">Revoke</button>` : ''}</td>
    </tr>`).join('');
}

async function generateInvite() {
  const data = await Auth.api('/api/admin/invites', { method: 'POST', body: JSON.stringify({}) });
  if (data && data.code) {
    toast(`Code generated: ${data.code} (copied)`);
    navigator.clipboard.writeText(data.code).catch(() => {});
    loadInvites();
  }
}

async function revokeInvite(id) {
  if (!confirm('Revoke this access code?')) return;
  const data = await Auth.api(`/api/admin/invites/${id}`, { method: 'DELETE' });
  if (data && data.ok) { toast('Code revoked'); loadInvites(); }
}

function copyCode(code) {
  navigator.clipboard.writeText(code).then(() => toast(`Copied: ${code}`));
}

// ── Rooms ─────────────────────────────────────────
async function loadRooms() {
  const data = await Auth.api('/api/admin/conversations');
  if (!data) return;
  allRooms = data.rooms;
  renderRooms(allRooms);
}

function renderRooms(rooms) {
  const typeLabel = { direct: 'Direct', group: 'Group', channel: 'Channel' };
  document.getElementById('roomsBody').innerHTML = rooms.length === 0
    ? '<tr><td colspan="6" class="empty-state">No nodes found</td></tr>'
    : rooms.map(r => `
    <tr>
      <td>
        <span class="td-primary">${r.name}</span>
        ${r.description ? `<span class="td-secondary">${r.description}</span>` : ''}
      </td>
      <td><span class="t-badge t-badge--type">${typeLabel[r.type]||r.type}</span></td>
      <td class="td-mono">${r.member_count}</td>
      <td class="td-mono">${r.message_count}</td>
      <td class="td-meta">${r.last_message ? formatTime(r.last_message_at) : '—'}</td>
      <td>${r.is_archived
        ? '<span class="t-badge t-badge--archived">Archived</span>'
        : '<span class="t-badge t-badge--active">● Active</span>'}</td>
    </tr>`).join('');
}

function filterRooms() {
  const q = document.getElementById('roomSearch').value.toLowerCase();
  renderRooms(allRooms.filter(r => r.name.toLowerCase().includes(q)));
}

// ── Export ────────────────────────────────────────
async function loadExport() {
  const data = await Auth.api('/api/admin/conversations');
  if (!data) return;

  document.getElementById('exportBody').innerHTML = data.rooms.map(r => `
    <tr>
      <td><span class="td-primary">${r.name}</span></td>
      <td><span class="t-badge t-badge--type">${r.type}</span></td>
      <td class="td-mono">${r.message_count}</td>
      <td class="td-mono">${r.member_count}</td>
      <td>
        <a href="/api/admin/export/${r.id}" download
           onclick="addAuthHeader(event, ${r.id})"
           class="t-btn t-btn--accent">⬇ Export_JSON</a>
      </td>
    </tr>`).join('');
}

async function addAuthHeader(e, roomId) {
  e.preventDefault();
  const token = Auth.getToken();
  const res = await fetch(`/api/admin/export/${roomId}`, { headers: { Authorization: `Bearer ${token}` } });
  const blob = await res.blob();
  const fname = res.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || `export-${roomId}.json`;
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fname; a.click();
  URL.revokeObjectURL(url);
  toast(`Downloaded: ${fname}`);
}

// ── Permissions Panel ─────────────────────────────
let currentPermUserId = null;

async function openPermsPanel(userId, username) {
  currentPermUserId = userId;
  document.getElementById('permsPanelTitle').textContent = `Permissions: ${username}`;
  document.getElementById('permsPanelBody').innerHTML = '<div class="u-dim">Loading...</div>';
  document.getElementById('permsPanel').classList.add('open');
  document.getElementById('permsOverlay').classList.add('open');

  // Ensure allUsers is populated (needed for agent checkboxes in renderPermsPanel)
  if (allUsers.length === 0) await loadUsers().catch(() => {});

  const data = await Auth.api(`/api/admin/users/${userId}/permissions`);
  if (!data) return;
  renderPermsPanel(data.permissions);
}

function renderPermsPanel(p) {
  const agents = allUsers.filter(u => u.role === 'agent');
  document.getElementById('permsPanelBody').innerHTML = `
    <div>
      <div class="perms-section-label perms-section-label--spaced">FILE_PERMISSIONS</div>
      <div class="perm-row">
        <span class="perm-row__label">can_send_files</span>
        <input type="checkbox" class="perm-toggle" id="perm_files" ${p.can_send_files ? 'checked' : ''}>
      </div>
    </div>
    <div>
      <div class="perms-section-label">MESSAGE_LIMITS</div>
      <div class="perm-row">
        <span class="perm-row__label">max_messages_per_day</span>
        <input type="number" class="perm-number-input" id="perm_maxmsg" placeholder="∞" value="${p.max_messages_per_day ?? ''}">
      </div>
    </div>
    <div>
      <div class="perms-section-label">AI_ACCESS</div>
      ${agents.length === 0 ? '<div class="u-dim">No AI agents configured.</div>' : agents.map(a => `
        <div class="perm-row">
          <span class="perm-row__label">${a.display_name}</span>
          <input type="checkbox" class="perm-toggle perm-agent" data-agent-id="${a.id}"
            ${(p.allowed_agents || []).includes(a.id) ? 'checked' : ''}>
        </div>
      `).join('')}
    </div>
  `;
}

async function savePermissions() {
  if (!currentPermUserId) return;
  const canSendFiles = document.getElementById('perm_files').checked;
  const maxMsg = document.getElementById('perm_maxmsg').value;
  const agentCheckboxes = document.querySelectorAll('.perm-agent');
  const allowedAgents = [...agentCheckboxes].filter(c => c.checked).map(c => parseInt(c.dataset.agentId));

  const payload = {
    can_send_files: canSendFiles,
    allowed_agents: allowedAgents,
    max_messages_per_day: maxMsg ? parseInt(maxMsg) : null,
  };

  const data = await Auth.api(`/api/admin/users/${currentPermUserId}/permissions`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
  if (data) { toast('Permissions saved'); closePermsPanel(); }
}

function closePermsPanel() {
  document.getElementById('permsPanel').classList.remove('open');
  document.getElementById('permsOverlay').classList.remove('open');
  currentPermUserId = null;
}

// ── Invite Wizard ────────────────────────────────
function openInviteModal() {
  const agents = allUsers.filter(u => u.role === 'agent');
  document.getElementById('inv_agents_section').innerHTML = agents.length === 0
    ? '<div class="u-dim no-agents-msg">No AI agents configured.</div>'
    : '<div class="ai-access-label">AI_ACCESS</div>' +
      agents.map(a => `
        <div class="perm-row">
          <span class="perm-row__label">${a.display_name}</span>
          <input type="checkbox" class="perm-toggle inv-agent" data-agent-id="${a.id}">
        </div>
      `).join('');
  document.getElementById('inviteNote').value = '';
  document.getElementById('inviteModal').classList.add('open');
  applyInvitePreset('standard');
}

function closeInviteModal() {
  document.getElementById('inviteModal').classList.remove('open');
}

function applyInvitePreset(preset) {
  const agents = document.querySelectorAll('.inv-agent');
  const filesToggle = document.getElementById('inv_files');
  if (preset === 'guest') { filesToggle.checked = false; agents.forEach(a => a.checked = false); }
  else if (preset === 'standard') { filesToggle.checked = true; agents.forEach(a => a.checked = false); }
  else if (preset === 'ai') { filesToggle.checked = true; agents.forEach(a => a.checked = true); }
}

async function generateInviteWithPerms() {
  const canSendFiles = document.getElementById('inv_files').checked;
  const agentCheckboxes = document.querySelectorAll('.inv-agent');
  const allowedAgents = [...agentCheckboxes].filter(c => c.checked).map(c => parseInt(c.dataset.agentId));
  const note = document.getElementById('inviteNote').value.trim();

  const data = await Auth.api('/api/admin/invites', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      note: note || null,
      default_permissions: { can_send_files: canSendFiles, allowed_agents: allowedAgents },
    }),
  });
  if (data) {
    closeInviteModal();
    toast(`Code generated: ${data.code}`);
    loadInvites();
  }
}

// ── Room Requests ─────────────────────────────────
async function loadRoomRequests() {
  const data = await Auth.api('/api/admin/room-requests');
  if (!data) return;
  const pending = data.requests.filter(r => r.status === 'pending');
  const badge = document.getElementById('requestsBadge');
  if (pending.length > 0) { badge.textContent = pending.length; badge.classList.remove('u-hidden'); }
  else { badge.classList.add('u-hidden'); }

  document.getElementById('requestsBody').innerHTML = data.requests.length === 0
    ? '<tr><td colspan="6" class="td-empty">No room requests yet.</td></tr>'
    : data.requests.map(r => `
      <tr>
        <td class="td-meta">${r.requester_display || r.requester_name}</td>
        <td><strong>${r.name}</strong>${r.description ? `<div class="td-meta">${r.description}</div>` : ''}</td>
        <td class="td-meta">${r.description || '—'}</td>
        <td class="td-meta">${formatDate(r.created_at)}</td>
        <td><span class="badge badge--${r.status}">${r.status}</span></td>
        <td>${r.status === 'pending' ? `
          <button class="t-btn t-btn--accent t-btn--approve" onclick="approveRequest(${r.id}, ${JSON.stringify(JSON.parse(r.requested_members || '[]'))})">Approve</button>
          <button class="t-btn t-btn--reject" onclick="rejectRequest(${r.id})">Reject</button>
        ` : r.admin_note ? `<span class="u-dim">${r.admin_note}</span>` : '—'}</td>
      </tr>
    `).join('');
}

async function approveRequest(id, memberIds) {
  const data = await Auth.api(`/api/admin/room-requests/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: 'approved', member_ids: memberIds }),
  });
  if (data) { toast('Room created and approved'); loadRoomRequests(); }
}

async function rejectRequest(id) {
  const data = await Auth.api(`/api/admin/room-requests/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: 'rejected' }),
  });
  if (data) { toast('Request rejected'); loadRoomRequests(); }
}

// ── Neural Search ────────────────────────────────
async function runSearch() {
  const q = document.getElementById('searchQuery').value.trim();
  const col = document.getElementById('searchCollection').value;
  if (!q) return;
  document.getElementById('searchResultsContainer').innerHTML = '<div class="u-dim">Searching neural network...</div>';

  const data = await Auth.api(`/api/admin/search?q=${encodeURIComponent(q)}&collection=${col}`);
  if (!data) return;
  if (!data.results || data.results.length === 0) {
    document.getElementById('searchResultsContainer').innerHTML = '<div class="u-dim">No results found.</div>';
    return;
  }

  document.getElementById('searchResultsContainer').innerHTML = data.results.map(r => `
    <div class="search-result">
      <div class="search-result__meta">
        <span class="badge badge--${r.collection === 'messages' ? 'approved' : 'pending'}">${r.collection}</span>
        ${r.metadata.sender ? `<span class="td-meta">${r.metadata.sender}</span>` : ''}
        ${r.metadata.ts ? `<span class="td-meta">${formatTime(r.metadata.ts)}</span>` : ''}
        <span class="search-score">score: ${(r.score * 100).toFixed(0)}%</span>
      </div>
      <div class="search-result__text">${r.text}</div>
    </div>
  `).join('');
}

// ── Init ──────────────────────────────────────────
loadOverview();
</script>
</body>
</html>
