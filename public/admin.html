<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ONE21 — Command Console</title>
<link rel="stylesheet" href="/css/design-system.css">
<link rel="stylesheet" href="/css/layers/pages/admin.css">
</head>
<body>

<div class="admin-layout">

  <!-- ══════════════════════════════════════
       SIDEBAR
       ══════════════════════════════════════ -->
  <nav class="admin-nav">

    <div class="admin-nav__brand">
      <div class="brand-logo">
        <span class="brand-logo__box">ONE</span>
        <span class="brand-logo__suffix">_21</span>
      </div>
      <span class="admin-nav__console-label">CONSOLE</span>
    </div>

    <div class="admin-nav__section">Command_Modules</div>

    <button class="admin-nav__item active" data-page="overview">
      <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Overview
    </button>
    <button class="admin-nav__item" data-page="users">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Node_Registry
    </button>
    <button class="admin-nav__item" data-page="invites">
      <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      Access_Codes
    </button>
    <button class="admin-nav__item" data-page="rooms">
      <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Node_Map
    </button>
    <button class="admin-nav__item" data-page="export">
      <svg viewBox="0 0 24 24"><polyline points="8 17 12 21 16 17"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"/></svg>
      Data_Export
    </button>

    <div class="admin-nav__footer">
      <button class="admin-nav__footer-btn" onclick="goToChat()">
        <svg viewBox="0 0 24 24"><polyline points="9 10 4 15 9 20"/><path d="M20 4v7a4 4 0 0 1-4 4H4"/></svg>
        Return_To_Chat
      </button>
      <button class="admin-nav__footer-btn admin-nav__footer-btn--danger" onclick="Auth.logout()">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Terminate_Session
      </button>
    </div>

  </nav>


  <!-- ══════════════════════════════════════
       MAIN CONTENT
       ══════════════════════════════════════ -->
  <main class="admin-main">

    <!-- ── OVERVIEW ── -->
    <div class="admin-page active" id="page-overview">

      <div class="admin-page-header">
        <div class="admin-page-label">System_Status</div>
        <div class="admin-page-title">Overview</div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-card__label">Loading...</div>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-section__header">
          <span class="admin-section__title">Recent_Activity</span>
          <button class="t-btn t-btn--accent" onclick="loadOverview()">
            <svg class="icon-svg icon-svg--xs" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Refresh
          </button>
        </div>
        <table id="recentTable">
          <thead>
            <tr>
              <th>Node_ID</th>
              <th>Access_Level</th>
              <th>Last_Transmission</th>
              <th>Msg_Count</th>
            </tr>
          </thead>
          <tbody id="recentBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── USERS ── -->
    <div class="admin-page" id="page-users">

      <div class="admin-page-header">
        <div class="admin-page-label">Access_Control</div>
        <div class="admin-page-title">Node_Registry</div>
      </div>

      <div class="admin-toolbar">
        <input class="admin-toolbar__input" type="text" id="userSearch" placeholder="QUERY_NODE..." oninput="filterUsers()">
        <span class="admin-toolbar__count" id="userCount"></span>
      </div>

      <div class="admin-section">
        <table id="usersTable">
          <thead>
            <tr>
              <th>Node_ID</th>
              <th>Access_Level</th>
              <th>Status</th>
              <th>Msg_Count</th>
              <th>Registered</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── INVITES ── -->
    <div class="admin-page" id="page-invites">

      <div class="admin-page-header">
        <div class="admin-page-label">Access_Management</div>
        <div class="admin-page-title">Access_Codes</div>
      </div>

      <div class="admin-toolbar">
        <button class="t-btn t-btn--accent t-btn--lg" onclick="generateInvite()">
          <svg class="icon-svg icon-svg--xs" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Generate_New_Code
        </button>
      </div>

      <div class="admin-section">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Issued_By</th>
              <th>Claimed_By</th>
              <th>Expires</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="invitesBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── ROOMS ── -->
    <div class="admin-page" id="page-rooms">

      <div class="admin-page-header">
        <div class="admin-page-label">Topology</div>
        <div class="admin-page-title">Node_Map</div>
      </div>

      <div class="admin-toolbar">
        <input class="admin-toolbar__input" type="text" id="roomSearch" placeholder="QUERY_NODE..." oninput="filterRooms()">
      </div>

      <div class="admin-section">
        <table id="roomsTable">
          <thead>
            <tr>
              <th>Node_Name</th>
              <th>Type</th>
              <th>Listeners</th>
              <th>Msg_Count</th>
              <th>Last_Transmission</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="roomsBody"></tbody>
        </table>
      </div>

    </div>


    <!-- ── EXPORT ── -->
    <div class="admin-page" id="page-export">

      <div class="admin-page-header">
        <div class="admin-page-label">Data_Operations</div>
        <div class="admin-page-title">Data_Export</div>
      </div>

      <div class="admin-section">
        <div class="admin-section__header">
          <span class="admin-section__title">Select_Node_For_Export</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Node_Name</th>
              <th>Type</th>
              <th>Msg_Count</th>
              <th>Listeners</th>
              <th>Export</th>
            </tr>
          </thead>
          <tbody id="exportBody"></tbody>
        </table>
      </div>

    </div>

  </main>
</div>


<script src="/js/auth.js"></script>
<script>
// ── Auth guard ──────────────────────────────────
if (!Auth.requireAuth()) {
  const u = Auth.getUser();
  if (u && u.role !== 'admin') {
    alert('Acces restricționat — doar administratori.');
    window.location.href = '/chat.html';
  }
}

let allUsers = [];
let allRooms = [];

// ── Navigation ────────────────────────────────────
document.querySelectorAll('.admin-nav__item[data-page]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.admin-nav__item').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`page-${btn.dataset.page}`).classList.add('active');

    const loaders = { overview: loadOverview, users: loadUsers, invites: loadInvites, rooms: loadRooms, export: loadExport };
    loaders[btn.dataset.page] && loaders[btn.dataset.page]();
  });
});

function goToChat() { window.location.href = '/chat.html'; }

// ── Toast ─────────────────────────────────────────
function toast(msg, duration = 2500) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), duration);
}

// ── Helpers ───────────────────────────────────────
function formatDate(iso) {
  if (!iso) return '—';
  const d = new Date(iso.includes('T') ? iso : iso.replace(' ', 'T') + 'Z');
  return d.toLocaleDateString('ro-RO', { day: '2-digit', month: 'short', year: 'numeric' });
}
function formatTime(iso) {
  if (!iso) return '—';
  const d = new Date(iso.includes('T') ? iso : iso.replace(' ', 'T') + 'Z');
  return d.toLocaleString('ro-RO', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
}

// ── Overview ──────────────────────────────────────
async function loadOverview() {
  const [statsData, usersData] = await Promise.all([
    Auth.api('/api/admin/stats'),
    Auth.api('/api/admin/users'),
  ]);
  if (!statsData || !usersData) return;

  const s = statsData.stats;
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card stat-card--accent">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
      <div class="stat-card__value">${s.users}</div>
      <div class="stat-card__label">Active_Nodes</div>
      <div class="stat-card__sub">${s.online_now} online now</div>
    </div>
    <div class="stat-card stat-card--blue">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <div class="stat-card__value">${s.messages.toLocaleString()}</div>
      <div class="stat-card__label">Total_Transmissions</div>
      <div class="stat-card__sub">${s.msg_today} today</div>
    </div>
    <div class="stat-card stat-card--warn">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      <div class="stat-card__value">${s.rooms}</div>
      <div class="stat-card__label">Active_Channels</div>
      <div class="stat-card__sub">${s.agents} AI agents</div>
    </div>
    <div class="stat-card stat-card--live">
      <svg class="stat-card__icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <div class="stat-card__value">${s.active_today}</div>
      <div class="stat-card__label">Active_Today</div>
      <div class="stat-card__sub">${s.invites_pending} invites pending</div>
    </div>`;

  const tbody = document.getElementById('recentBody');
  tbody.innerHTML = usersData.users.map(u => `
    <tr>
      <td>
        <span class="td-primary">${u.display_name}</span>
        <span class="td-secondary">@${u.username}</span>
      </td>
      <td><span class="t-badge t-badge--${u.role}">${u.role}</span></td>
      <td class="td-meta">${formatTime(u.last_seen)}</td>
      <td class="td-mono">${u.message_count}</td>
    </tr>`).join('');
}

// ── Users ─────────────────────────────────────────
async function loadUsers() {
  const data = await Auth.api('/api/admin/users');
  if (!data) return;
  allUsers = data.users;
  document.getElementById('userCount').textContent = `${allUsers.length} nodes registered`;
  renderUsers(allUsers);
}

function renderUsers(users) {
  const me = Auth.getUser();
  document.getElementById('usersBody').innerHTML = users.map(u => `
    <tr>
      <td>
        <span class="td-primary">${u.display_name}</span>
        <span class="td-secondary">@${u.username}</span>
        ${u.invited_by_name ? `<span class="td-secondary u-dim">invited by @${u.invited_by_name}</span>` : ''}
      </td>
      <td>
        ${u.id === me.id
          ? `<span class="t-badge t-badge--${u.role}">${u.role}</span>`
          : `<select class="inline-select" onchange="changeRole(${u.id}, this.value)">
              <option value="admin"  ${u.role==='admin'  ? 'selected':''}>ADMIN</option>
              <option value="user"   ${u.role==='user'   ? 'selected':''}>USER</option>
              <option value="agent"  ${u.role==='agent'  ? 'selected':''}>AGENT</option>
            </select>`
        }
      </td>
      <td>
        <span class="t-status t-status--${u.is_online ? 'online' : 'offline'}">
          <span class="t-status__dot"></span>
          ${u.is_online ? 'Online' : 'Offline'}
        </span>
      </td>
      <td class="td-mono">${u.message_count}</td>
      <td class="td-meta">${formatDate(u.created_at)}</td>
      <td>
        ${u.id !== me.id ? `<button class="t-btn t-btn--accent" onclick="editDisplayName(${u.id}, '${u.display_name.replace(/'/g, "\\'")}')">Edit_Name</button>` : '—'}
      </td>
    </tr>`).join('');
}

function filterUsers() {
  const q = document.getElementById('userSearch').value.toLowerCase();
  renderUsers(allUsers.filter(u => u.username.includes(q) || u.display_name.toLowerCase().includes(q)));
}

async function changeRole(userId, newRole) {
  const data = await Auth.api(`/api/admin/users/${userId}`, { method: 'PUT', body: JSON.stringify({ role: newRole }) });
  if (data && !data.error) toast(`Role updated: ${data.user.username} → ${newRole}`);
  else toast('Update failed');
}

async function editDisplayName(userId, currentName) {
  const newName = prompt('New display name:', currentName);
  if (!newName || newName.trim() === currentName) return;
  const data = await Auth.api(`/api/admin/users/${userId}`, { method: 'PUT', body: JSON.stringify({ display_name: newName.trim() }) });
  if (data && !data.error) { toast('Name updated'); loadUsers(); }
}

// ── Invites ───────────────────────────────────────
async function loadInvites() {
  const data = await Auth.api('/api/admin/invites');
  if (!data) return;

  document.getElementById('invitesBody').innerHTML = data.invites.length === 0
    ? '<tr><td colspan="6" class="empty-state">No access codes found</td></tr>'
    : data.invites.map(inv => `
    <tr>
      <td><span class="invite-code" onclick="copyCode('${inv.code}')" title="Click to copy">${inv.code}</span></td>
      <td class="td-meta">${inv.created_by_name || '—'}</td>
      <td>${inv.used_by_name
        ? `<span class="td-primary">${inv.used_by_display}</span><span class="td-secondary">@${inv.used_by_name}</span>`
        : '<span class="td-empty">—</span>'}</td>
      <td class="td-meta">${inv.expires_at ? formatDate(inv.expires_at) : 'No_Expiry'}</td>
      <td>${inv.used_by
        ? '<span class="t-badge t-badge--used">✓ Claimed</span>'
        : '<span class="t-badge t-badge--active">● Active</span>'}</td>
      <td>${!inv.used_by ? `<button class="t-btn t-btn--danger" onclick="revokeInvite(${inv.id})">Revoke</button>` : ''}</td>
    </tr>`).join('');
}

async function generateInvite() {
  const data = await Auth.api('/api/admin/invites', { method: 'POST', body: JSON.stringify({}) });
  if (data && data.code) {
    toast(`Code generated: ${data.code} (copied)`);
    navigator.clipboard.writeText(data.code).catch(() => {});
    loadInvites();
  }
}

async function revokeInvite(id) {
  if (!confirm('Revoke this access code?')) return;
  const data = await Auth.api(`/api/admin/invites/${id}`, { method: 'DELETE' });
  if (data && data.ok) { toast('Code revoked'); loadInvites(); }
}

function copyCode(code) {
  navigator.clipboard.writeText(code).then(() => toast(`Copied: ${code}`));
}

// ── Rooms ─────────────────────────────────────────
async function loadRooms() {
  const data = await Auth.api('/api/admin/conversations');
  if (!data) return;
  allRooms = data.rooms;
  renderRooms(allRooms);
}

function renderRooms(rooms) {
  const typeLabel = { direct: 'Direct', group: 'Group', channel: 'Channel' };
  document.getElementById('roomsBody').innerHTML = rooms.length === 0
    ? '<tr><td colspan="6" class="empty-state">No nodes found</td></tr>'
    : rooms.map(r => `
    <tr>
      <td>
        <span class="td-primary">${r.name}</span>
        ${r.description ? `<span class="td-secondary">${r.description}</span>` : ''}
      </td>
      <td><span class="t-badge t-badge--type">${typeLabel[r.type]||r.type}</span></td>
      <td class="td-mono">${r.member_count}</td>
      <td class="td-mono">${r.message_count}</td>
      <td class="td-meta">${r.last_message ? formatTime(r.last_message_at) : '—'}</td>
      <td>${r.is_archived
        ? '<span class="t-badge t-badge--archived">Archived</span>'
        : '<span class="t-badge t-badge--active">● Active</span>'}</td>
    </tr>`).join('');
}

function filterRooms() {
  const q = document.getElementById('roomSearch').value.toLowerCase();
  renderRooms(allRooms.filter(r => r.name.toLowerCase().includes(q)));
}

// ── Export ────────────────────────────────────────
async function loadExport() {
  const data = await Auth.api('/api/admin/conversations');
  if (!data) return;

  document.getElementById('exportBody').innerHTML = data.rooms.map(r => `
    <tr>
      <td><span class="td-primary">${r.name}</span></td>
      <td><span class="t-badge t-badge--type">${r.type}</span></td>
      <td class="td-mono">${r.message_count}</td>
      <td class="td-mono">${r.member_count}</td>
      <td>
        <a href="/api/admin/export/${r.id}" download
           onclick="addAuthHeader(event, ${r.id})"
           class="t-btn t-btn--accent">⬇ Export_JSON</a>
      </td>
    </tr>`).join('');
}

async function addAuthHeader(e, roomId) {
  e.preventDefault();
  const token = Auth.getToken();
  const res = await fetch(`/api/admin/export/${roomId}`, { headers: { Authorization: `Bearer ${token}` } });
  const blob = await res.blob();
  const fname = res.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || `export-${roomId}.json`;
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fname; a.click();
  URL.revokeObjectURL(url);
  toast(`Downloaded: ${fname}`);
}

// ── Init ──────────────────────────────────────────
loadOverview();
</script>
</body>
</html>
